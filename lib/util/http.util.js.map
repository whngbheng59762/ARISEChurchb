{"version":3,"sources":["../../src/util/http.util.js"],"names":["ctx","next","denyList","getModuleControllerAction","path","module","controller","action","modules","getAllModules","includes","ctrl","koahub","controllers","_ctrl","methods","prototype","filter","value","status","isArray","args","runAction","key","push","split","union","paths","substr","length","config"],"mappings":"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","file":"http.util.js","sourcesContent":["import lodash from \"lodash\";\nimport {http as httpDebug} from \"./log.util\";\n\n// run module/controller/action\nexport async function runAction(ctx, next, denyList = true, ...args) {\n\n    const {module, controller, action} = getModuleControllerAction(ctx.path);\n\n    const modules = getAllModules();\n    if (!lodash.includes(modules, module)) {\n\n        httpDebug('Not Found Module');\n        return;\n    }\n\n    const ctrl = koahub.controllers[`/${module}/${controller}`];\n    if (ctrl) {\n\n        const _ctrl = new ctrl(ctx, next);\n        const methods = Object.getOwnPropertyNames(ctrl.prototype).filter(function (value) {\n            return value !== 'constructor';\n        });\n\n        // constructor不响应404，中断执行\n        if (ctx.status != 404) {\n            return;\n        }\n\n        if (denyList) {\n            // denyList禁用控制器方法\n            if (_ctrl.denyList) {\n                if (lodash.isArray(_ctrl.denyList)) {\n                    if (lodash.includes(_ctrl.denyList, action)) {\n                        return;\n                    }\n                }\n            }\n        }\n\n        if (lodash.includes(methods, action)) {\n\n            try {\n\n                // 控制器前置\n                if (lodash.includes(methods, '_before')) {\n                    await _ctrl['_before'](...args);\n                }\n\n                // 方法前置\n                if (lodash.includes(methods, `_before_${action}`)) {\n                    await _ctrl[`_before_${action}`](...args);\n                }\n\n                await _ctrl[action](...args);\n\n                // 控制器后置\n                if (lodash.includes(methods, `_after_${action}`)) {\n                    await _ctrl[`_after_${action}`](...args);\n                }\n\n                // 方法后置\n                if (lodash.includes(methods, '_after')) {\n                    await _ctrl['_after'](...args);\n                }\n            } catch (err) {\n                throw err;\n            }\n        } else {\n\n            // 控制器空操作\n            if (lodash.includes(methods, '_empty')) {\n                await _ctrl['_empty'](...args);\n            } else {\n                httpDebug('Not Found Action');\n            }\n        }\n    } else {\n\n        httpDebug('Not Found Controller');\n    }\n}\n\n// get all modules\nexport function getAllModules() {\n\n    let modules = [];\n    for (let key in koahub.controllers) {\n        modules.push(key.split('/')[1]);\n    }\n    modules = lodash.union(modules);\n    return modules;\n}\n\n// get module controller action\nexport function getModuleControllerAction(path) {\n\n    let paths = [];\n    if (path != '/') {\n        paths = path.substr(1, path.length).split('/');\n    }\n\n    let module = koahub.config('default_module');\n    let controller = koahub.config('default_controller');\n    let action = koahub.config('default_action');\n\n    switch (paths.length) {\n        case 0:\n\n            break;\n        case 1:\n\n            module = paths[0];\n            break;\n        case 2:\n\n            module = paths[0];\n            controller = paths[1];\n            break;\n        case 3:\n\n            module = paths[0];\n            controller = paths[1];\n            action = paths[2];\n            break;\n        default:\n\n            module = paths[0];\n            controller = '';\n            for (let key in paths) {\n                if (key > 0 && key < paths.length - 1) {\n                    if (key == paths.length - 2) {\n                        controller += paths[key];\n                        break;\n                    }\n                    controller += paths[key] + '/';\n                }\n            }\n            action = paths[paths.length - 1];\n    }\n\n    return {\n        module: module,\n        controller: controller,\n        action: action\n    }\n}"]}