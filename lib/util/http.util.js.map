{"version":3,"sources":["../../src/util/http.util.js"],"names":["ctx","next","denyList","getModuleControllerAction","path","module","controller","action","includes","koahub","modules","ctrl","controllers","_ctrl","methods","prototype","filter","value","status","isArray","args","result","parseResult","data","body","runAction","urlObjToParam","query","obj","param","key","substr","length","paths","split","config"],"mappings":";;;;;;;;;;;;;;;;;;;AAGA;;0EACO,iBAAyBA,GAAzB,EAA8BC,IAA9B;AAAA,YAAoCC,QAApC,uEAA+C,IAA/C;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,gDAEoCC,0BAA0BH,IAAII,IAA9B,CAFpC,EAEKC,MAFL,yBAEKA,MAFL,EAEaC,UAFb,yBAEaA,UAFb,EAEyBC,MAFzB,yBAEyBA,MAFzB;;AAAA,4BAIE,iBAAOC,QAAP,CAAgBC,OAAOC,OAAvB,EAAgCL,MAAhC,CAJF;AAAA;AAAA;AAAA;;AAMC,uCAAU,kBAAV;AAND;;AAAA;AAUGM,4BAVH,GAUUF,OAAOG,WAAP,OAAuBP,MAAvB,SAAiCC,UAAjC,CAVV;;AAAA,6BAWCK,IAXD;AAAA;AAAA;AAAA;;AAaOE,6BAbP,GAae,IAAIF,IAAJ,CAASX,GAAT,EAAcC,IAAd,CAbf;AAcOa,+BAdP,GAciB,mCAA2BH,KAAKI,SAAhC,EAA2CC,MAA3C,CAAkD,UAASC,KAAT,EAAgB;AAC9E,mCAAOA,UAAU,aAAjB;AACH,yBAFe,CAdjB;;AAkBC;;AAlBD,8BAmBKjB,IAAIkB,MAAJ,IAAc,GAnBnB;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA,6BAuBKhB,QAvBL;AAAA;AAAA;AAAA;;AAAA,6BAyBSW,MAAMX,QAzBf;AAAA;AAAA;AAAA;;AAAA,6BA0Ba,iBAAOiB,OAAP,CAAeN,MAAMX,QAArB,CA1Bb;AAAA;AAAA;AAAA;;AAAA,6BA2BiB,iBAAOM,QAAP,CAAgBK,MAAMX,QAAtB,EAAgCK,MAAhC,CA3BjB;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAAA,kDAAwDa,IAAxD;AAAwDA,gCAAxD;AAAA;;AAAA,6BAkCK,iBAAOZ,QAAP,CAAgBM,OAAhB,EAAyBP,MAAzB,CAlCL;AAAA;AAAA;AAAA;;AAAA;AAsCac,8BAtCb;;AAuCaC,mCAvCb,GAuC2B,SAAdA,WAAc,CAASC,IAAT,EAAe;AAC7B,gCAAIA,IAAJ,EAAU;AACNC,uCAAOD,IAAP;AACH;AACJ,yBA3CV;AA4CS;;;AA5CT,6BA6Ca,iBAAOf,QAAP,CAAgBM,OAAhB,EAAyB,SAAzB,CA7Cb;AAAA;AAAA;AAAA;;AAAA;AAAA,+BA8C+BD,MAAM,SAAN,eAAoBO,IAApB,CA9C/B;;AAAA;AAAA;AA8CaE,mCA9Cb;;AAAA;AAAA,6BAkDa,iBAAOd,QAAP,CAAgBM,OAAhB,eAAoCP,MAApC,CAlDb;AAAA;AAAA;AAAA;;AAAA;AAAA,+BAmD+BM,mBAAiBN,MAAjB,eAA8Ba,IAA9B,CAnD/B;;AAAA;AAAA;AAmDaE,mCAnDb;;AAAA;AAAA;AAAA,+BAsD2BT,MAAMN,MAAN,eAAiBa,IAAjB,CAtD3B;;AAAA;AAAA;AAsDSE,mCAtDT;;AAAA,6BAyDa,iBAAOd,QAAP,CAAgBM,OAAhB,cAAmCP,MAAnC,CAzDb;AAAA;AAAA;AAAA;;AAAA;AAAA,+BA0D+BM,kBAAgBN,MAAhB,eAA6Ba,IAA7B,CA1D/B;;AAAA;AAAA;AA0DaE,mCA1Db;;AAAA;AAAA,6BA8Da,iBAAOd,QAAP,CAAgBM,OAAhB,EAAyB,QAAzB,CA9Db;AAAA;AAAA;AAAA;;AAAA;AAAA,+BA+D+BD,MAAM,QAAN,eAAmBO,IAAnB,CA/D/B;;AAAA;AAAA;AA+DaE,mCA/Db;;AAAA;AAAA,yDAiEgBD,MAjEhB;;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA,6BAwES,iBAAOb,QAAP,CAAgBM,OAAhB,EAAyB,QAAzB,CAxET;AAAA;AAAA;AAAA;;AAAA;AAAA,+BAyEeD,MAAM,QAAN,eAAmBO,IAAnB,CAzEf;;AAAA;AAAA;AAAA;;AAAA;AA2ES,uCAAU,kBAAV;;AA3ET;AAAA;AAAA;;AAAA;;AAgFC,uCAAU,sBAAV;;AAhFD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,K;;oBAAeK,S;;;;;AAoFtB;;;QACgBC,a,GAAAA,a;QAeAvB,yB,GAAAA,yB;;AAxGhB;;;;AACA;;;;AAwFO,SAASuB,aAAT,CAAuBC,KAAvB,EAA8BC,GAA9B,EAAmC;;AAEtC,QAAIC,QAAQ,EAAZ;AACA,SAAK,IAAIC,GAAT,IAAgBF,GAAhB,EAAqB;AACjBC,iBAAS,MAAMC,GAAN,GAAY,GAAZ,GAAkBF,IAAIE,GAAJ,CAA3B;AACH;;AAEDD,YAAQ,MAAMA,MAAME,MAAN,CAAa,CAAb,EAAgBF,MAAMG,MAAtB,CAAd;AACA,QAAIL,KAAJ,EAAW;AACPE,iBAAS,MAAMF,KAAf;AACH;AACD,WAAOE,KAAP;AACH;;AAED;AACO,SAAS1B,yBAAT,CAAmCC,IAAnC,EAAyC;;AAE5C,QAAI6B,QAAQ,EAAZ;AACA,QAAI7B,QAAQ,GAAZ,EAAiB;AACb6B,gBAAQ7B,KAAK2B,MAAL,CAAY,CAAZ,EAAe3B,KAAK4B,MAApB,EAA4BE,KAA5B,CAAkC,GAAlC,CAAR;AACH;;AAED,QAAI7B,SAASI,OAAO0B,MAAP,CAAc,gBAAd,CAAb;AACA,QAAI7B,aAAaG,OAAO0B,MAAP,CAAc,oBAAd,CAAjB;AACA,QAAI5B,SAASE,OAAO0B,MAAP,CAAc,gBAAd,CAAb;;AAEA,YAAQF,MAAMD,MAAd;AACI,aAAK,CAAL;;AAEI;AACJ,aAAK,CAAL;;AAEI3B,qBAAS4B,MAAM,CAAN,CAAT;AACA;AACJ,aAAK,CAAL;;AAEI5B,qBAAS4B,MAAM,CAAN,CAAT;AACA3B,yBAAa2B,MAAM,CAAN,CAAb;AACA;AACJ,aAAK,CAAL;;AAEI5B,qBAAS4B,MAAM,CAAN,CAAT;AACA3B,yBAAa2B,MAAM,CAAN,CAAb;AACA1B,qBAAS0B,MAAM,CAAN,CAAT;AACA;AACJ;;AAEI5B,qBAAS4B,MAAM,CAAN,CAAT;AACA3B,yBAAa,EAAb;AACA,iBAAK,IAAIwB,GAAT,IAAgBG,KAAhB,EAAuB;AACnB,oBAAIH,MAAM,CAAN,IAAWA,MAAMG,MAAMD,MAAN,GAAe,CAApC,EAAuC;AACnC,wBAAIF,OAAOG,MAAMD,MAAN,GAAe,CAA1B,EAA6B;AACzB1B,sCAAc2B,MAAMH,GAAN,CAAd;AACA;AACH;AACDxB,kCAAc2B,MAAMH,GAAN,IAAa,GAA3B;AACH;AACJ;AACDvB,qBAAS0B,MAAMA,MAAMD,MAAN,GAAe,CAArB,CAAT;AAhCR;;AAmCA,WAAO;AACH3B,gBAAQA,MADL;AAEHC,oBAAYA,UAFT;AAGHC,gBAAQA;AAHL,KAAP;AAKH","file":"http.util.js","sourcesContent":["import lodash from \"lodash\";\nimport { http as httpDebug } from \"./log.util\";\n\n// run module/controller/action\nexport async function runAction(ctx, next, denyList = true, ...args) {\n\n    const { module, controller, action } = getModuleControllerAction(ctx.path);\n\n    if (!lodash.includes(koahub.modules, module)) {\n\n        httpDebug('Not Found Module');\n        return;\n    }\n\n    const ctrl = koahub.controllers[`/${module}/${controller}`];\n    if (ctrl) {\n\n        const _ctrl = new ctrl(ctx, next);\n        const methods = Object.getOwnPropertyNames(ctrl.prototype).filter(function(value) {\n            return value !== 'constructor';\n        });\n\n        // constructor不响应404，中断执行\n        if (ctx.status != 404) {\n            return;\n        }\n\n        if (denyList) {\n            // denyList禁用控制器方法\n            if (_ctrl.denyList) {\n                if (lodash.isArray(_ctrl.denyList)) {\n                    if (lodash.includes(_ctrl.denyList, action)) {\n                        return;\n                    }\n                }\n            }\n        }\n\n        if (lodash.includes(methods, action)) {\n\n            try {\n\n                let result;\n                let parseResult = function(data) {\n                    if (data) {\n                        body = data;\n                    }\n                };\n                // 控制器前置\n                if (lodash.includes(methods, '_before')) {\n                    parseResult(await _ctrl['_before'](...args));\n                }\n\n                // 方法前置\n                if (lodash.includes(methods, `_before_${action}`)) {\n                    parseResult(await _ctrl[`_before_${action}`](...args));\n                }\n\n                parseResult(await _ctrl[action](...args));\n\n                // 控制器后置\n                if (lodash.includes(methods, `_after_${action}`)) {\n                    parseResult(await _ctrl[`_after_${action}`](...args));\n                }\n\n                // 方法后置\n                if (lodash.includes(methods, '_after')) {\n                    parseResult(await _ctrl['_after'](...args));\n                }\n                return result;\n            } catch (err) {\n                throw err;\n            }\n        } else {\n\n            // 控制器空操作\n            if (lodash.includes(methods, '_empty')) {\n                await _ctrl['_empty'](...args);\n            } else {\n                httpDebug('Not Found Action');\n            }\n        }\n    } else {\n\n        httpDebug('Not Found Controller');\n    }\n}\n\n// url obj to param\nexport function urlObjToParam(query, obj) {\n\n    let param = '';\n    for (let key in obj) {\n        param += '&' + key + '=' + obj[key];\n    }\n\n    param = '?' + param.substr(1, param.length);\n    if (query) {\n        param += '&' + query;\n    }\n    return param;\n}\n\n// get module controller action\nexport function getModuleControllerAction(path) {\n\n    let paths = [];\n    if (path != '/') {\n        paths = path.substr(1, path.length).split('/');\n    }\n\n    let module = koahub.config('default_module');\n    let controller = koahub.config('default_controller');\n    let action = koahub.config('default_action');\n\n    switch (paths.length) {\n        case 0:\n\n            break;\n        case 1:\n\n            module = paths[0];\n            break;\n        case 2:\n\n            module = paths[0];\n            controller = paths[1];\n            break;\n        case 3:\n\n            module = paths[0];\n            controller = paths[1];\n            action = paths[2];\n            break;\n        default:\n\n            module = paths[0];\n            controller = '';\n            for (let key in paths) {\n                if (key > 0 && key < paths.length - 1) {\n                    if (key == paths.length - 2) {\n                        controller += paths[key];\n                        break;\n                    }\n                    controller += paths[key] + '/';\n                }\n            }\n            action = paths[paths.length - 1];\n    }\n\n    return {\n        module: module,\n        controller: controller,\n        action: action\n    }\n}\n"]}