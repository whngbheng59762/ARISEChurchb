{"version":3,"sources":["../../src/util/http.util.js"],"names":["ctx","next","getModuleControllerAction","path","module","controller","action","includes","koahub","modules","ctrl","controllers","filters","substr","_ctrl","methods","prototype","status","args","result","parseResult","data","getPromiseFunction","runAction","urlObjToParam","method","wrap","bind","query","obj","param","key","length","paths","split","config"],"mappings":"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","file":"http.util.js","sourcesContent":["import co from \"co\";\nimport lodash from \"lodash\";\nimport {isGeneratorFunction} from \"./default.util\";\nimport log from \"./log.util\";\n\n// generator to promise\nfunction getPromiseFunction(ctx, _ctrl, method) {\n    if (isGeneratorFunction(_ctrl[method])) {\n        return co.wrap(_ctrl[method]).bind(_ctrl);\n    }\n    return _ctrl[method].bind(_ctrl);\n}\n\n// run module/controller/action\nexport async function runAction(ctx, next, ...args) {\n\n    const {module, controller, action} = getModuleControllerAction(ctx.path);\n\n    if (!lodash.includes(koahub.modules, module)) {\n\n        log('Not Found Module');\n        return;\n    }\n\n    const ctrl = koahub.controllers[`/${module}/${controller}`];\n    const filters = ['constructor', '_initialize', '_before', `_before_${action}`, `_after_${action}`, '_after', '_empty'];\n\n    // 方法首字符是`_`表示私有方法\n    if (ctrl && action.substr(0, 1) != '_' && !lodash.includes(filters, action)) {\n\n        const _ctrl = new ctrl(ctx, next);\n        const methods = Object.getOwnPropertyNames(ctrl.prototype);\n\n        // constructor不响应404，中断执行\n        if (ctx.status != 404) {\n            return;\n        }\n\n        if (lodash.includes(methods, action)) {\n\n            try {\n                let result;\n                let parseResult = function (data) {\n                    if (data) {\n                        result = data;\n                    }\n                };\n\n                // 控制器初始化\n                if (lodash.includes(methods, '_initialize')) {\n                    parseResult(await getPromiseFunction(ctx, _ctrl, '_initialize')(...args));\n                }\n                // 控制器初始化不响应404，中断执行\n                if (ctx.status != 404) {\n                    return;\n                }\n\n                // 控制器前置\n                if (lodash.includes(methods, '_before')) {\n                    parseResult(await getPromiseFunction(ctx, _ctrl, '_before')(...args));\n                }\n                // 控制器前置不响应404，中断执行\n                if (ctx.status != 404) {\n                    return;\n                }\n\n                // 方法前置\n                if (lodash.includes(methods, `_before_${action}`)) {\n                    parseResult(await getPromiseFunction(ctx, _ctrl, `_before_${action}`)(...args));\n                }\n                // 方法前置不响应404，中断执行\n                if (ctx.status != 404) {\n                    return;\n                }\n\n                parseResult(await getPromiseFunction(ctx, _ctrl, action)(...args));\n                // 不响应404，中断执行\n                if (ctx.status != 404) {\n                    return;\n                }\n\n                // 方法后置\n                if (lodash.includes(methods, `_after_${action}`)) {\n                    parseResult(await getPromiseFunction(ctx, _ctrl, `_after_${action}`)(...args));\n                }\n                // 方法后置不响应404，中断执行\n                if (ctx.status != 404) {\n                    return;\n                }\n\n                // 控制器后置\n                if (lodash.includes(methods, '_after')) {\n                    parseResult(await getPromiseFunction(ctx, _ctrl, '_after')(...args));\n                }\n                // 控制器后置不响应404，中断执行\n                if (ctx.status != 404) {\n                    return;\n                }\n\n                return result;\n            } catch (err) {\n                throw err;\n            }\n        } else {\n\n            // 控制器空操作\n            if (lodash.includes(methods, '_empty')) {\n                await _ctrl['_empty'](...args);\n            } else {\n                log('Not Found Action');\n            }\n        }\n    } else {\n\n        log('Not Found Controller');\n    }\n}\n\n// url obj to param\nexport function urlObjToParam(query, obj) {\n\n    let param = '';\n    for (let key in obj) {\n        param += '&' + key + '=' + obj[key];\n    }\n\n    param = '?' + param.substr(1, param.length);\n    if (query) {\n        param += '&' + query;\n    }\n    return param;\n}\n\n// get module controller action\nexport function getModuleControllerAction(path) {\n\n    let paths = [];\n    if (path != '/') {\n        paths = path.substr(1, path.length).split('/');\n    }\n\n    let module = koahub.config('default_module');\n    let controller = koahub.config('default_controller');\n    let action = koahub.config('default_action');\n\n    switch (paths.length) {\n        case 0:\n\n            break;\n        case 1:\n\n            module = paths[0];\n            break;\n        case 2:\n\n            module = paths[0];\n            controller = paths[1];\n            break;\n        case 3:\n\n            module = paths[0];\n            controller = paths[1];\n            action = paths[2];\n            break;\n        default:\n\n            module = paths[0];\n            controller = '';\n            for (let key in paths) {\n                if (key > 0 && key < paths.length - 1) {\n                    if (key == paths.length - 2) {\n                        controller += paths[key];\n                        break;\n                    }\n                    controller += paths[key] + '/';\n                }\n            }\n            action = paths[paths.length - 1];\n    }\n\n    return {\n        module: module,\n        controller: controller,\n        action: action\n    }\n}\n"]}