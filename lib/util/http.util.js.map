{"version":3,"sources":["../../src/util/http.util.js"],"names":["lodash","http","httpDebug","runAction","ctx","next","args","module","controller","action","getModuleControllerAction","path","includes","koahub","modules","ctrl","controllers","filters","substr","_ctrl","methods","Object","getOwnPropertyNames","prototype","status","result","parseResult","data","err","urlObjToParam","query","obj","param","key","length","paths","split","config"],"mappings":"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","file":"http.util.js","sourcesContent":["import lodash from \"lodash\";\nimport {http as httpDebug} from \"./log.util\";\n\n// run module/controller/action\nexport async function runAction(ctx, next, ...args) {\n\n    const {module, controller, action} = getModuleControllerAction(ctx.path);\n\n    if (!lodash.includes(koahub.modules, module)) {\n\n        httpDebug('Not Found Module');\n        return;\n    }\n\n    const ctrl = koahub.controllers[`/${module}/${controller}`];\n    const filters = ['constructor', '_initialize', '_before', `_before_${action}`, `_after_${action}`, '_after', '_empty'];\n\n    // 方法首字符是`_`表示私有方法\n    if (ctrl && action.substr(0, 1) != '_' && !lodash.includes(filters, action)) {\n\n        const _ctrl = new ctrl(ctx, next);\n        const methods = Object.getOwnPropertyNames(ctrl.prototype);\n\n        // constructor不响应404，中断执行\n        if (ctx.status != 404) {\n            return;\n        }\n\n        if (lodash.includes(methods, action)) {\n\n            try {\n                let result;\n                let parseResult = function (data) {\n                    if (data) {\n                        result = data;\n                    }\n                };\n\n                // 控制器初始化\n                if (lodash.includes(methods, '_initialize')) {\n                    parseResult(await _ctrl['_initialize'](...args));\n                }\n                // 控制器初始化不响应404，中断执行\n                if (ctx.status != 404) {\n                    return;\n                }\n\n                // 控制器前置\n                if (lodash.includes(methods, '_before')) {\n                    parseResult(await _ctrl['_before'](...args));\n                }\n                // 控制器前置不响应404，中断执行\n                if (ctx.status != 404) {\n                    return;\n                }\n\n                // 方法前置\n                if (lodash.includes(methods, `_before_${action}`)) {\n                    parseResult(await _ctrl[`_before_${action}`](...args));\n                }\n                // 方法前置不响应404，中断执行\n                if (ctx.status != 404) {\n                    return;\n                }\n\n                parseResult(await _ctrl[action](...args));\n                // 不响应404，中断执行\n                if (ctx.status != 404) {\n                    return;\n                }\n\n                // 方法后置\n                if (lodash.includes(methods, `_after_${action}`)) {\n                    parseResult(await _ctrl[`_after_${action}`](...args));\n                }\n                // 方法后置不响应404，中断执行\n                if (ctx.status != 404) {\n                    return;\n                }\n\n                // 控制器后置\n                if (lodash.includes(methods, '_after')) {\n                    parseResult(await _ctrl['_after'](...args));\n                }\n                // 控制器后置不响应404，中断执行\n                if (ctx.status != 404) {\n                    return;\n                }\n\n                return result;\n            } catch (err) {\n                throw err;\n            }\n        } else {\n\n            // 控制器空操作\n            if (lodash.includes(methods, '_empty')) {\n                await _ctrl['_empty'](...args);\n            } else {\n                httpDebug('Not Found Action');\n            }\n        }\n    } else {\n\n        httpDebug('Not Found Controller');\n    }\n}\n\n// url obj to param\nexport function urlObjToParam(query, obj) {\n\n    let param = '';\n    for (let key in obj) {\n        param += '&' + key + '=' + obj[key];\n    }\n\n    param = '?' + param.substr(1, param.length);\n    if (query) {\n        param += '&' + query;\n    }\n    return param;\n}\n\n// get module controller action\nexport function getModuleControllerAction(path) {\n\n    let paths = [];\n    if (path != '/') {\n        paths = path.substr(1, path.length).split('/');\n    }\n\n    let module = koahub.config('default_module');\n    let controller = koahub.config('default_controller');\n    let action = koahub.config('default_action');\n\n    switch (paths.length) {\n        case 0:\n\n            break;\n        case 1:\n\n            module = paths[0];\n            break;\n        case 2:\n\n            module = paths[0];\n            controller = paths[1];\n            break;\n        case 3:\n\n            module = paths[0];\n            controller = paths[1];\n            action = paths[2];\n            break;\n        default:\n\n            module = paths[0];\n            controller = '';\n            for (let key in paths) {\n                if (key > 0 && key < paths.length - 1) {\n                    if (key == paths.length - 2) {\n                        controller += paths[key];\n                        break;\n                    }\n                    controller += paths[key] + '/';\n                }\n            }\n            action = paths[paths.length - 1];\n    }\n\n    return {\n        module: module,\n        controller: controller,\n        action: action\n    }\n}\n"]}