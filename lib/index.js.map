{"version":3,"sources":["../src/index.js"],"names":["path","http","Koa","lodash","logger","favicon","packageFile","Loader","Hook","Http","config","httpMiddleware","log","debug","global","Promise","require","default","Koahub","constructor","koahub","app","init","loadErrors","on","err","ctx","process","reason","promise","message","indexOf","exit","loadPaths","rootPath","cwd","runtimeFile","mainModule","filename","runtimePath","dirname","runtimeName","relative","paths","loadConfigs","configs","loader","index","merge","Object","assign","loadUtils","name","value","undefined","loadLoaders","key","loadModules","modules","controllers","split","length","push","union","loadMiddlewares","use","getServer","server","Server","callback","getKoa","loadHttpMiddlewares","next","hook","skip","test","run","port","start","listen","started","version","env","NODE_ENV"],"mappings":"AAAA,OAAOA,IAAP,MAAiB,MAAjB;AACA,OAAOC,IAAP,MAAiB,MAAjB;AACA,OAAOC,GAAP,MAAgB,KAAhB;AACA,OAAOC,MAAP,MAAmB,QAAnB;AACA,OAAOC,MAAP,MAAmB,YAAnB;AACA,OAAOC,OAAP,MAAoB,aAApB;AACA,OAAOC,WAAP,MAAwB,mBAAxB;AACA,OAAOC,MAAP,MAAmB,oBAAnB;AACA,OAAOC,IAAP,MAAiB,kBAAjB;AACA,OAAOC,IAAP,MAAiB,kBAAjB;AACA,OAAOC,MAAP,MAAmB,uBAAnB;AACA,SAAQC,cAAR,QAA6B,8BAA7B;AACA,OAAOC,GAAP,IAAaC,KAAb,QAAyB,iBAAzB;;AAEA;AACAC,OAAOC,OAAP,GAAiBC,QAAQ,UAAR,CAAjB;AACAA,QAAQ,+BAAR,EAAyCC,OAAzC,GAAmDF,OAAnD;;AAEA,eAAe,MAAMG,MAAN,CAAa;;AAExBC,kBAAc;;AAEV;AACAL,eAAOM,MAAP,GAAgBd,WAAhB;AACA;AACAc,eAAOC,GAAP,GAAa,IAAInB,GAAJ,EAAb;;AAEA,aAAKoB,IAAL;AACH;;AAEDC,iBAAa;;AAET;AACAH,eAAOC,GAAP,CAAWG,EAAX,CAAc,OAAd,EAAuB,UAAUC,GAAV,EAAeC,GAAf,EAAoB;AACvCb,kBAAMY,GAAN;AACH,SAFD;;AAIA;AACAE,gBAAQH,EAAR,CAAW,oBAAX,EAAiC,UAAUI,MAAV,EAAkBC,OAAlB,EAA2B;AACxDhB,kBAAMe,MAAN;AACH,SAFD;;AAIA;AACAD,gBAAQH,EAAR,CAAW,mBAAX,EAAgC,UAAUC,GAAV,EAAe;AAC3CZ,kBAAMY,GAAN;;AAEA,gBAAIA,IAAIK,OAAJ,CAAYC,OAAZ,CAAoB,cAApB,IAAsC,CAAC,CAA3C,EAA8C;AAC1CJ,wBAAQK,IAAR;AACH;AACJ,SAND;AAOH;;AAEDC,gBAAY;;AAER,cAAMC,WAAWP,QAAQQ,GAAR,EAAjB;AACA,cAAMC,cAAcT,QAAQU,UAAR,CAAmBC,QAAvC;AACA,cAAMC,cAAcvC,KAAKwC,OAAL,CAAaJ,WAAb,CAApB;AACA,cAAMK,cAAczC,KAAK0C,QAAL,CAAcR,QAAd,EAAwBK,WAAxB,CAApB;;AAEAnB,eAAOuB,KAAP,GAAe;AACXT,sBAAUA,QADC;AAEXE,yBAAaA,WAFF;AAGXG,yBAAaA,WAHF;AAIXE,yBAAaA;AAJF,SAAf;AAMH;;AAEDG,kBAAc;;AAEV;AACAxB,eAAOyB,OAAP,GAAiB,IAAItC,MAAJ,CAAWa,OAAOuB,KAAP,CAAaJ,WAAxB,EAAqC7B,OAAOoC,MAAP,CAAcD,OAAnD,CAAjB;AACAzB,eAAOyB,OAAP,CAAeE,KAAf,GAAuB5C,OAAO6C,KAAP,CAAaC,OAAOC,MAAP,CAAc,EAAd,EAAkBxC,MAAlB,CAAb,EAAwCU,OAAOyB,OAAP,CAAeE,KAAvD,CAAvB;AACH;;AAEDI,gBAAY;;AAER;AACA/B,eAAOV,MAAP,GAAgB,UAAU0C,IAAV,EAAgBC,KAAhB,EAAuB;AACnC,gBAAID,QAAQE,SAAZ,EAAuB;AACnB,uBAAOlC,OAAOyB,OAAP,CAAeE,KAAtB;AACH,aAFD,MAEO;AACH,oBAAIM,SAASC,SAAb,EAAwB;AACpB,2BAAOlC,OAAOyB,OAAP,CAAeE,KAAf,CAAqBK,IAArB,CAAP;AACH,iBAFD,MAEO;AACHhC,2BAAOyB,OAAP,CAAeE,KAAf,CAAqBK,IAArB,IAA6BC,KAA7B;AACH;AACJ;AACJ,SAVD;;AAYA;AACAjC,eAAOnB,IAAP,GAAcQ,IAAd;AACH;;AAED8C,kBAAc;;AAEV,aAAK,IAAIC,GAAT,IAAgBpC,OAAOV,MAAP,CAAc,QAAd,CAAhB,EAAyC;;AAErC;AACA,gBAAI8C,OAAO,SAAX,EAAsB;AAClB;AACH;AACDpC,mBAAOoC,GAAP,IAAc,IAAIjD,MAAJ,CAAWa,OAAOuB,KAAP,CAAaJ,WAAxB,EAAqCnB,OAAOV,MAAP,CAAc,QAAd,EAAwB8C,GAAxB,CAArC,CAAd;AACH;;AAED;AACA,aAAKC,WAAL;AACH;;AAEDA,kBAAc;;AAEV,YAAIC,UAAU,EAAd;AACA,aAAK,IAAIF,GAAT,IAAgBpC,OAAOuC,WAAvB,EAAoC;AAChC,gBAAIhB,QAAQa,IAAII,KAAJ,CAAU,GAAV,CAAZ;AACA,gBAAIjB,MAAMkB,MAAN,GAAe,CAAnB,EAAsB;AAClB;AACH;AACDH,oBAAQI,IAAR,CAAanB,MAAM,CAAN,CAAb;AACH;AACDvB,eAAOsC,OAAP,GAAiBvD,OAAO4D,KAAP,CAAaL,OAAb,CAAjB;AACH;;AAEDM,sBAAkB;;AAEd;AACA,YAAI5C,OAAOV,MAAP,CAAc,QAAd,CAAJ,EAA6B;AACzBU,mBAAOC,GAAP,CAAW4C,GAAX,CAAe7D,QAAf;AACH;;AAED;AACAgB,eAAOC,GAAP,CAAW4C,GAAX,CAAe5D,QAAQe,OAAOV,MAAP,CAAc,SAAd,CAAR,CAAf;AACH;;AAEDY,WAAO;;AAEH,aAAKC,UAAL;AACA,aAAKU,SAAL;AACA,aAAKW,WAAL;AACA,aAAKO,SAAL;AACA,aAAKI,WAAL;AACA,aAAKS,eAAL;AACH;;AAED;AACAE,gBAAY;;AAER,cAAMC,SAASlE,KAAKmE,MAAL,CAAYhD,OAAOC,GAAP,CAAWgD,QAAX,EAAZ,CAAf;AACA,eAAO,KAAKF,MAAL,GAAcA,MAArB;AACH;;AAED;AACAG,aAAS;;AAEL,eAAOlD,OAAOC,GAAd;AACH;;AAEDkD,0BAAsB;;AAElB;AACA,YAAInD,OAAOV,MAAP,CAAc,MAAd,CAAJ,EAA2B;AACvBU,mBAAOC,GAAP,CAAW4C,GAAX,CAAe,gBAAgBvC,GAAhB,EAAqB8C,IAArB,EAA2B;AACtCpD,uBAAOqD,IAAP,GAAc,IAAIjE,IAAJ,CAASkB,GAAT,EAAc8C,IAAd,CAAd;AACA,sBAAMA,MAAN;AACH,aAHD;AAIH;;AAED;AACApD,eAAOC,GAAP,CAAW4C,GAAX,CAAetD,iBAAiB+D,IAAjB,CAAsB,UAAUhD,GAAV,EAAe;;AAEhD,kBAAM1B,OAAO0B,IAAI1B,IAAjB;;AAEA;AACA,gBAAI,gBAAgB2E,IAAhB,CAAqB3E,IAArB,CAAJ,EAAgC;AAC5B,uBAAO,IAAP;AACH;;AAED;AACA,gBAAI,OAAO2E,IAAP,CAAY3E,IAAZ,CAAJ,EAAuB;AACnB,uBAAO,IAAP;AACH;;AAED,mBAAO,KAAP;AACH,SAfc,CAAf;AAgBH;;AAED4E,QAAIC,IAAJ,EAAU;;AAEN,aAAKN,mBAAL;;AAEA,YAAI,CAACM,IAAL,EAAW;AACPA,mBAAOzD,OAAOV,MAAP,CAAc,MAAd,CAAP;AACH;;AAED,aAAKoE,KAAL,CAAWD,IAAX;AACH;;AAEDC,UAAMD,IAAN,EAAY;;AAER,YAAI,KAAKV,MAAT,EAAiB;AACb,iBAAKA,MAAL,CAAYY,MAAZ,CAAmBF,IAAnB;AACH,SAFD,MAEO;AACH,iBAAKX,SAAL,GAAiBa,MAAjB,CAAwBF,IAAxB;AACH;;AAED,aAAKG,OAAL,CAAaH,IAAb;AACH;;AAEDG,YAAQH,IAAR,EAAc;;AAEVjE,YAAK,oBAAkBQ,OAAO6D,OAAQ,GAAtC;AACArE,YAAK,sCAAL;AACAA,YAAK,uBAAqBe,QAAQuD,GAAR,CAAYC,QAAZ,IAAwB,aAAc,GAAhE;AACAvE,YAAK,wCAAsCiE,IAAK,GAAhD;AACH;AAlMuB","file":"index.js","sourcesContent":["import path from \"path\";\nimport http from \"http\";\nimport Koa from \"koa\";\nimport lodash from \"lodash\";\nimport logger from \"koa-logger\";\nimport favicon from \"koa-favicon\";\nimport packageFile from \"./../package.json\";\nimport Loader from \"./lib/loader.class\";\nimport Hook from \"./lib/hook.class\";\nimport Http from \"./lib/http.class\";\nimport config from \"./config/index.config\";\nimport {httpMiddleware} from \"./middleware/http.middleware\";\nimport log, {debug} from \"./util/log.util\";\n\n//rewite promise, bluebird is more faster\nglobal.Promise = require('bluebird');\nrequire('babel-runtime/core-js/promise').default = Promise;\n\nexport default class Koahub {\n\n    constructor() {\n\n        // 加载全局变量\n        global.koahub = packageFile;\n        // new Koa()\n        koahub.app = new Koa();\n\n        this.init();\n    }\n\n    loadErrors() {\n\n        // 监控错误日志\n        koahub.app.on(\"error\", function (err, ctx) {\n            debug(err);\n        });\n\n        // 捕获promise reject错误\n        process.on('unhandledRejection', function (reason, promise) {\n            debug(reason);\n        });\n\n        // 捕获未知错误\n        process.on('uncaughtException', function (err) {\n            debug(err);\n\n            if (err.message.indexOf(' EADDRINUSE ') > -1) {\n                process.exit();\n            }\n        });\n    }\n\n    loadPaths() {\n\n        const rootPath = process.cwd();\n        const runtimeFile = process.mainModule.filename;\n        const runtimePath = path.dirname(runtimeFile);\n        const runtimeName = path.relative(rootPath, runtimePath);\n\n        koahub.paths = {\n            rootPath: rootPath,\n            runtimeFile: runtimeFile,\n            runtimePath: runtimePath,\n            runtimeName: runtimeName\n        };\n    }\n\n    loadConfigs() {\n\n        // Object.assign({}, config) 创建新对象，不允许覆盖config\n        koahub.configs = new Loader(koahub.paths.runtimePath, config.loader.configs);\n        koahub.configs.index = lodash.merge(Object.assign({}, config), koahub.configs.index);\n    }\n\n    loadUtils() {\n\n        // config函数\n        koahub.config = function (name, value) {\n            if (name == undefined) {\n                return koahub.configs.index;\n            } else {\n                if (value == undefined) {\n                    return koahub.configs.index[name];\n                } else {\n                    koahub.configs.index[name] = value;\n                }\n            }\n        };\n\n        // controller依赖http\n        koahub.http = Http;\n    }\n\n    loadLoaders() {\n\n        for (let key in koahub.config('loader')) {\n\n            // 移除configs重复加载\n            if (key == 'configs') {\n                continue;\n            }\n            koahub[key] = new Loader(koahub.paths.runtimePath, koahub.config('loader')[key]);\n        }\n\n        // 加载模块\n        this.loadModules();\n    }\n\n    loadModules() {\n\n        let modules = [];\n        for (let key in koahub.controllers) {\n            let paths = key.split('/');\n            if (paths.length < 3) {\n                continue;\n            }\n            modules.push(paths[1]);\n        }\n        koahub.modules = lodash.union(modules);\n    }\n\n    loadMiddlewares() {\n\n        // log middleware\n        if (koahub.config('logger')) {\n            koahub.app.use(logger());\n        }\n\n        // favicon middleware\n        koahub.app.use(favicon(koahub.config('favicon')));\n    }\n\n    init() {\n\n        this.loadErrors();\n        this.loadPaths();\n        this.loadConfigs();\n        this.loadUtils();\n        this.loadLoaders();\n        this.loadMiddlewares();\n    }\n\n    // 支持soket.io\n    getServer() {\n\n        const server = http.Server(koahub.app.callback());\n        return this.server = server;\n    }\n\n    // 支持自定义中间件\n    getKoa() {\n\n        return koahub.app;\n    }\n\n    loadHttpMiddlewares() {\n\n        // 加载hook中间件\n        if (koahub.config('hook')) {\n            koahub.app.use(async function (ctx, next) {\n                koahub.hook = new Hook(ctx, next);\n                await next();\n            });\n        }\n\n        // 加载http中间件\n        koahub.app.use(httpMiddleware().skip(function (ctx) {\n\n            const path = ctx.path;\n\n            // path验证，资源文件跳过中间件\n            if (/[^\\/]+\\.+\\w+$/.test(path)) {\n                return true;\n            }\n\n            // path验证，无效跳过中间件\n            if (/\\/\\//.test(path)) {\n                return true;\n            }\n\n            return false;\n        }));\n    }\n\n    run(port) {\n\n        this.loadHttpMiddlewares();\n\n        if (!port) {\n            port = koahub.config('port');\n        }\n\n        this.start(port);\n    }\n\n    start(port) {\n\n        if (this.server) {\n            this.server.listen(port);\n        } else {\n            this.getServer().listen(port);\n        }\n\n        this.started(port);\n    }\n\n    started(port) {\n\n        log(`Koahub Version: ${koahub.version}`);\n        log(`Koahub Website: http://js.koahub.com`);\n        log(`Server Enviroment: ${process.env.NODE_ENV || 'development'}`);\n        log(`Server running at: http://127.0.0.1:${port}`);\n    }\n}"]}