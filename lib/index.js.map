{"version":3,"sources":["../src/index.js"],"names":["Koahub","options","global","koahub","app","init","configs","loader","config","name","value","undefined","index","rootPath","process","cwd","appName","appPath","resolve","runtime","runtimePath","runtimeFile","argv","paths","runtimeName","http","controllers","controller","key","log","type","console","Date","models","model","services","service","use","loadConfigs","loadPaths","loadControllers","loadModels","loadServices","loadUtils","loadMiddlewares","server","Server","callback","on","err","ctx","reason","promise","message","indexOf","exit","next","hook","skip","path","test","clusterOnCPUs","numCPUs","cpus","length","i","fork","red","worker","code","signal","pid","nextTick","port","loadHttpMiddlewares","handleError","isMaster","runWatcher","runCluster","start","started","listen","getServer","green","version"],"mappings":"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","file":"index.js","sourcesContent":["import path from \"path\";\nimport http from \"http\";\nimport cluster from \"cluster\";\nimport os from \"os\";\nimport Koa from \"koa\";\nimport logger from \"koa-logger\";\nimport favicon from \"koa-favicon\";\nimport colors from \"colors/safe\";\nimport packageFile from \"./../package.json\";\nimport Loader from \"./lib/loader.class\";\nimport Hook from \"./lib/hook.class\";\nimport Http from \"./data/http.class\";\nimport Watcher from \"./lib/watcher.class\";\nimport config from \"./config/index.config\";\nimport configDefault from \"./config/default.config\";\nimport {httpMiddleware} from \"./middleware/http.middleware\";\nimport {debug as captureDebug} from \"./util/log.util\";\nimport {dateFormat} from \"./util/time.util\";\n\nexport default class Koahub {\n\n    constructor(options = {}) {\n\n        // 加载全局变量\n        global.koahub = packageFile;\n        // new Koa()\n        koahub.app = new Koa();\n\n        this.init();\n    }\n\n    loadConfigs() {\n\n        koahub.configs = new Loader(configDefault.loader.config);\n        // config函数\n        koahub.config = function (name, value) {\n\n            if (name == undefined) {\n\n                return Object.assign(config, koahub.configs.index);\n            } else {\n\n                if (value == undefined) {\n                    return Object.assign(config, koahub.configs.index)[name];\n                } else {\n                    koahub.configs.index[name] = value;\n                }\n            }\n        };\n    }\n\n    loadPaths() {\n\n        const rootPath = process.cwd();\n        const appName = configDefault.app;\n        const appPath = path.resolve(rootPath, appName);\n        const runtime = configDefault.runtime;\n        const runtimePath = path.resolve(rootPath, runtime);\n        const runtimeFile = process.argv[1];\n\n        koahub.paths = {\n            rootPath: rootPath,\n            appName: appName,\n            appPath: appPath,\n            runtimeName: runtime,\n            runtimePath: runtimePath,\n            runtimeFile: runtimeFile\n        };\n    }\n\n    loadControllers() {\n\n        // controller依赖http\n        koahub.http = Http;\n        koahub.controllers = new Loader(configDefault.loader.controller);\n    }\n\n    loadUtils() {\n\n        // 自定义loader\n        if (koahub.config('loader')) {\n            for (let key in koahub.config('loader')) {\n                koahub[key] = new Loader(koahub.config('loader')[key]);\n            }\n        }\n        koahub.log = function (log, type = 'log') {\n            if (typeof log == 'string') {\n                console[type](`[${dateFormat(new Date(), 'yyyy-MM-dd hh:mm:ss')}] [Koahubjs] ${log}`);\n            } else {\n                console[type](log);\n            }\n        }\n    }\n\n    loadModels() {\n\n        koahub.models = new Loader(configDefault.loader.model);\n    }\n\n    loadServices() {\n\n        koahub.services = new Loader(configDefault.loader.service);\n    }\n\n    loadMiddlewares() {\n\n        // log middleware\n        if (koahub.config('logger')) {\n            koahub.app.use(logger());\n        }\n\n        // favicon middleware\n        koahub.app.use(favicon(koahub.config('favicon')));\n    }\n\n    init() {\n\n        this.loadConfigs();\n        this.loadPaths();\n        this.loadControllers();\n        this.loadModels();\n        this.loadServices();\n        this.loadUtils();\n        this.loadMiddlewares();\n    }\n\n    // 支持soket.io\n    getServer() {\n\n        const server = http.Server(koahub.app.callback());\n        return this.server = server;\n    }\n\n    // 支持自定义中间件\n    getKoa() {\n\n        return koahub.app;\n    }\n\n    handleError() {\n\n        // 监控错误日志\n        koahub.app.on(\"error\", function (err, ctx) {\n            captureDebug(err);\n        });\n\n        // 捕获promise reject错误\n        process.on('unhandledRejection', function (reason, promise) {\n            captureDebug(reason);\n        });\n\n        // 捕获未知错误\n        process.on('uncaughtException', function (err) {\n            captureDebug(err);\n\n            if (err.message.indexOf(' EADDRINUSE ') > -1) {\n                process.exit(0);\n            }\n        });\n    }\n\n    loadHttpMiddlewares() {\n\n        // 加载hook中间件\n        if (koahub.config('hook')) {\n            koahub.app.use(async function (ctx, next) {\n\n                koahub.hook = new Hook(ctx, next);\n                await next();\n            });\n        }\n\n        // 加载http中间件\n        koahub.app.use(httpMiddleware().skip(function (ctx) {\n\n            const path = ctx.path;\n\n            // path验证，资源文件跳过中间件\n            if (/[^\\/]+\\.+\\w+$/.test(path)) {\n                return true;\n            }\n\n            // path验证，无效跳过中间件\n            if (/\\/\\//.test(path)) {\n                return true;\n            }\n\n            return false;\n        }));\n    }\n\n    runWatcher() {\n\n        // 主进程监控\n        new Watcher(koahub.paths);\n    }\n\n    runCluster(clusterOnCPUs = true) {\n\n        if (clusterOnCPUs) {\n\n            // 主进程多进程fork\n            const numCPUs = os.cpus().length;\n            for (let i = 0; i < numCPUs; i++) {\n                cluster.fork();\n            }\n\n            koahub.log(colors.red('[Tips] In cluster mode, Multiple processes can\\'t be Shared memory, Such as session'));\n        } else {\n\n            cluster.fork();\n        }\n\n        cluster.on('exit', function (worker, code, signal) {\n\n            // 正常退出，不重启\n            if (code == 0) {\n                process.exit();\n                return;\n            }\n\n            if (koahub.config('debug')) {\n                koahub.log(colors.red('worker ' + worker.process.pid + ' died'));\n            }\n\n            process.nextTick(function () {\n                cluster.fork();\n            });\n        });\n    }\n\n    run(port) {\n\n        this.loadHttpMiddlewares();\n        this.handleError();\n\n        if (!port) {\n            port = koahub.config('port');\n        }\n\n        if (cluster.isMaster) {\n\n            if (koahub.config('watcher')) {\n                this.runWatcher();\n\n                if (koahub.config('cluster')) {\n                    this.runCluster();\n                } else {\n                    this.runCluster(false);\n                }\n            } else {\n\n                if (koahub.config('cluster')) {\n                    this.runCluster();\n                } else {\n                    this.start(port);\n                }\n            }\n\n            this.started(port);\n        } else {\n\n            this.start(port);\n        }\n    }\n\n    start(port) {\n\n        if (koahub.config('debug')) {\n            koahub.log(colors.red('worker ' + process.pid + ' started'));\n        }\n\n        if (this.server) {\n            this.server.listen(port);\n        } else {\n            this.getServer().listen(port);\n        }\n    }\n\n    started(port) {\n\n        koahub.log(colors.green(`Koahubjs version: ${koahub.version}`));\n        koahub.log(colors.green(`Koahubjs website: http://js.koahub.com`));\n        koahub.log(colors.green(`Server Cluster Status: ${koahub.config('cluster')}`));\n        koahub.log(colors.green(`Server Debug Status: ${koahub.config('debug')}`));\n        koahub.log(colors.green(`Server File Watcher: ${koahub.config('watcher')}`));\n        koahub.log(colors.green(`Server running at http://127.0.0.1:${port}`));\n    }\n}"]}