{"version":3,"sources":["../src/index.js"],"names":["global","koahub","merge","app","init","configs","loader","config","index","appName","app_path","mainFile","process","argv","mainPath","dirname","appPath","resolve","paths","http","controllers","controller","hook","utils","util","models","model","services","service","log_on","use","favicon","loadConfigs","loadPaths","loadControllers","loadModels","loadServices","loadUtils","loadHooks","loadMiddlewares","server","Server","callback","on","err","ctx","reason","promise","skip","path","substr","length","split","indexOf","module","default_module","default_controller","action","default_action","url","key","redirect","port","loadHttpMiddlewares","handleError","listen","getServer","console","log","version"],"mappings":"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","file":"index.js","sourcesContent":["import path from \"path\";\nimport http from \"http\";\nimport Koa from \"koa\";\nimport logger from \"koa-logger\";\nimport favicon from \"koa-favicon\";\nimport lodash from \"lodash\";\nimport packageFile from \"./../package.json\";\nimport Loader from \"./lib/loader.class\";\nimport Hook from \"./lib/hook.class\";\nimport Http from \"./data/http.class\";\nimport config from \"./config/index.config\";\nimport configDefault from \"./config/default.config\";\nimport {httpMiddleware} from \"./middleware/http.middleware\";\nimport debug from \"./util/debug.util\";\n\nexport default class {\n\n    constructor() {\n\n        // 加载全局变量\n        global.koahub = lodash.merge({}, packageFile);\n        // new Koa()\n        koahub.app = new Koa();\n\n        this.init();\n    }\n\n    loadConfigs() {\n\n        koahub.configs = new Loader(configDefault.loader.config);\n        koahub.configs.index = Object.assign(config, koahub.configs.index);\n    }\n\n    loadPaths() {\n\n        const appName = configDefault.app_path;\n        const mainFile = process.argv[1];\n        const mainPath = path.dirname(mainFile);\n        const appPath = path.resolve(mainPath, appName);\n\n        koahub.paths = {\n            mainFile: mainFile,\n            mainPath: mainPath,\n            appName: appName,\n            appPath: appPath\n        };\n    }\n\n    loadControllers() {\n\n        // controller依赖http\n        koahub.http = Http;\n        koahub.controllers = new Loader(configDefault.loader.controller);\n    }\n\n    loadHooks() {\n\n        koahub.hook = new Hook();\n    }\n\n    loadUtils() {\n\n        koahub.utils = new Loader(configDefault.loader.util);\n    }\n\n    loadModels() {\n\n        koahub.models = new Loader(configDefault.loader.model);\n    }\n\n    loadServices() {\n\n        koahub.services = new Loader(configDefault.loader.service);\n    }\n\n    loadMiddlewares() {\n\n        // log middleware\n        if (koahub.configs.index.log_on) {\n            koahub.app.use(logger());\n        }\n\n        // favicon middleware\n        koahub.app.use(favicon(koahub.configs.index.favicon));\n    }\n\n    init() {\n\n        this.loadConfigs();\n        this.loadPaths();\n        this.loadControllers();\n        this.loadModels();\n        this.loadServices();\n        this.loadUtils();\n        this.loadHooks();\n        this.loadMiddlewares();\n    }\n\n    // 支持soket.io\n    getServer() {\n\n        const server = http.Server(koahub.app.callback());\n        return this.server = server;\n    }\n\n    // 支持自定义中间件\n    getKoa() {\n\n        return koahub.app;\n    }\n\n    handleError() {\n\n        // 监控错误日志\n        koahub.app.on(\"error\", function (err, ctx) {\n            debug(err);\n        });\n\n        // 捕获promise reject错误\n        process.on('unhandledRejection', function (reason, promise) {\n            debug(reason);\n        });\n\n        // 捕获未知错误\n        process.on('uncaughtException', function (err) {\n            debug(err);\n        });\n    }\n\n    loadHttpMiddlewares() {\n\n        // 加载http中间件\n        koahub.app.use(httpMiddleware().skip(function (ctx) {\n\n            const path = ctx.path;\n            if (path == '/') {\n                return false;\n            }\n\n            // path验证，无效跳过中间件\n            const paths = path.substr(1, path.length).split('/');\n            if (paths[paths.length - 1].indexOf('.') != -1) {\n                return true;\n            }\n\n            // path验证, 无效跳转\n            let module = koahub.configs.index.default_module;\n            let controller = koahub.configs.index.default_controller;\n            let action = koahub.configs.index.default_action;\n\n            let url = '';\n            for (let key in paths) {\n                if (!paths[key]) {\n                    ctx.redirect(url);\n                    return true;\n                } else {\n                    url += '/' + paths[key];\n                }\n            }\n\n            return false;\n        }));\n    }\n\n    run(port) {\n\n        this.loadHttpMiddlewares();\n        this.handleError();\n\n        if (!port) {\n            port = koahub.configs.index.port;\n        }\n\n        if (this.server) {\n            this.server.listen(port);\n        } else {\n            this.getServer().listen(port);\n        }\n\n        console.log(`[Koahubjs] Koahubjs version: ${koahub.version}`);\n        console.log(`[Koahubjs] Koahubjs website: http://js.koahub.com`);\n        console.log(`[Koahubjs] Server running at http://127.0.0.1:${port}`);\n    }\n}"]}