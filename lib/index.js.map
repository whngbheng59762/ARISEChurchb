{"version":3,"sources":["../src/index.js"],"names":["global","koahub","undefined","merge","loadPaths","app_path","app","appName","mainFile","process","argv","mainPath","dirname","appPath","resolve","paths","http","controllers","loader","controller","hook","utils","util","lodash","models","model","configs","config","default","log_on","use","favicon","loadControllers","loadModels","loadUtils","loadConfigs","loadHooks","loadMiddlewares","ctx","next","path","server","Server","callback","port","init","listen","getServer","console","log","version"],"mappings":"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","file":"index.js","sourcesContent":["import path from \"path\";\nimport http from \"http\";\nimport packageFile from \"./../package.json\";\nimport Koa from \"koa\";\nimport logger from \"koa-logger\";\nimport favicon from \"koa-favicon\";\nimport lodash from \"lodash\";\nimport Loader from \"./lib/loader.class\";\nimport Http from \"./data/http.class\";\nimport Hook from \"./lib/hook.class\";\nimport config from \"./config/default.config\";\nimport {runAction} from \"./util/default.util\";\n\nexport default class {\n\n    constructor() {\n\n        if (global.koahub == undefined) {\n            // 加载全局变量\n            global.koahub = lodash.merge({}, packageFile);\n        }\n\n        this.loadPaths(config.app_path);\n\n        // new Koa()\n        const app = new Koa();\n\n        koahub.app = app;\n    }\n\n    loadPaths(appName) {\n\n        let mainFile = process.argv[1];\n        let mainPath = path.dirname(mainFile);\n        let appPath = path.resolve(mainPath, appName);\n\n        koahub.paths = {\n            mainFile: mainFile,\n            mainPath: mainPath,\n            appName: appName,\n            appPath: appPath\n        };\n    }\n\n    loadControllers() {\n        // controller依赖http\n        koahub.http = Http;\n        koahub.controllers = new Loader(config.loader.controller);\n    }\n\n    loadHooks() {\n        koahub.hook = new Hook();\n    }\n\n    loadUtils() {\n        koahub.utils = new Loader(config.loader.util);\n        koahub.utils.lodash = lodash;\n    }\n\n    loadModels() {\n        koahub.models = new Loader(config.loader.model);\n    }\n\n    loadConfigs() {\n        koahub.configs = new Loader(config.loader.config);\n        koahub.configs.default = Object.assign(config, koahub.configs.default);\n    }\n\n    loadMiddlewares() {\n        if (koahub.configs.default.log_on) {\n            koahub.app.use(logger());\n        }\n        koahub.app.use(favicon(koahub.configs.default.favicon));\n    }\n\n    init() {\n        this.loadControllers();\n        this.loadModels();\n        this.loadUtils();\n        this.loadConfigs();\n        this.loadHooks();\n        this.loadMiddlewares();\n\n        koahub.app.use(function (ctx, next) {\n\n            koahub.ctx = ctx;\n\n            // 快捷方法\n            global.ctx = ctx;\n\n            runAction(ctx.path, true);\n        });\n    }\n\n    // 支持soket.io\n    getServer() {\n        const server = http.Server(koahub.app.callback());\n        return this.server = server;\n    }\n\n    // 支持自定义中间件\n    getKoa() {\n        return koahub.app;\n    }\n\n    run(port = config.port) {\n\n        this.init();\n\n        if (this.server) {\n            this.server.listen(port);\n        } else {\n            this.getServer().listen(port);\n        }\n\n        console.log(`[Koahubjs] Server running at http://127.0.0.1:${port}`);\n        console.log(`[Koahubjs] Koahubjs version: ${koahub.version}`);\n    }\n}\n"]}