{"version":3,"sources":["../src/index.js"],"names":["options","global","koahub","merge","app","init","configs","loader","config","index","rootPath","process","cwd","appName","runtime","appPath","resolve","runtimePath","paths","runtimeName","watch_on","http","controllers","controller","hook","utils","util","models","model","services","service","log_on","use","favicon","loadConfigs","loadPaths","loadControllers","loadModels","loadServices","loadUtils","loadHooks","loadMiddlewares","server","Server","callback","on","err","ctx","reason","promise","skip","path","substr","length","split","indexOf","module","default_module","default_controller","action","default_action","url","key","redirect","port","loadHttpMiddlewares","handleError","listen","started","getServer","loadWatcher","console","log","green","version"],"mappings":"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","file":"index.js","sourcesContent":["import path from \"path\";\nimport http from \"http\";\nimport Koa from \"koa\";\nimport logger from \"koa-logger\";\nimport favicon from \"koa-favicon\";\nimport lodash from \"lodash\";\nimport colors from \"colors/safe\";\nimport packageFile from \"./../package.json\";\nimport Loader from \"./lib/loader.class\";\nimport Hook from \"./lib/hook.class\";\nimport Http from \"./data/http.class\";\nimport Watcher from \"./lib/watcher.class\";\nimport config from \"./config/index.config\";\nimport configDefault from \"./config/default.config\";\nimport {httpMiddleware} from \"./middleware/http.middleware\";\nimport {debug as captureDebug} from \"./util/log.util\";\n\nexport default class {\n\n    constructor(options = {}) {\n\n        // 加载全局变量\n        global.koahub = lodash.merge({}, packageFile);\n        // new Koa()\n        koahub.app = new Koa();\n\n        this.init();\n    }\n\n    loadConfigs() {\n\n        koahub.configs = new Loader(configDefault.loader.config);\n        koahub.configs.index = Object.assign(config, koahub.configs.index);\n    }\n\n    loadPaths() {\n\n        const rootPath = process.cwd();\n        const appName = configDefault.app;\n        const runtime = configDefault.runtime;\n        const appPath = path.resolve(rootPath, appName);\n        const runtimePath = path.resolve(rootPath, runtime);\n\n        koahub.paths = {\n            rootPath: rootPath,\n            appName: appName,\n            appPath: appPath,\n            runtimeName: runtime,\n            runtimePath: runtimePath\n        };\n    }\n\n    loadWatcher(paths) {\n\n        // watch依赖config\n        if (koahub.configs.index.watch_on) {\n            new Watcher(paths);\n        }\n    }\n\n    loadControllers() {\n\n        // controller依赖http\n        koahub.http = Http;\n        koahub.controllers = new Loader(configDefault.loader.controller);\n    }\n\n    loadHooks() {\n\n        koahub.hook = new Hook();\n    }\n\n    loadUtils() {\n\n        koahub.utils = new Loader(configDefault.loader.util);\n    }\n\n    loadModels() {\n\n        koahub.models = new Loader(configDefault.loader.model);\n    }\n\n    loadServices() {\n\n        koahub.services = new Loader(configDefault.loader.service);\n    }\n\n    loadMiddlewares() {\n\n        // log middleware\n        if (koahub.configs.index.log_on) {\n            koahub.app.use(logger());\n        }\n\n        // favicon middleware\n        koahub.app.use(favicon(koahub.configs.index.favicon));\n    }\n\n    init() {\n\n        this.loadConfigs();\n        this.loadPaths();\n        this.loadControllers();\n        this.loadModels();\n        this.loadServices();\n        this.loadUtils();\n        this.loadHooks();\n        this.loadMiddlewares();\n    }\n\n    // 支持soket.io\n    getServer() {\n\n        const server = http.Server(koahub.app.callback());\n        return this.server = server;\n    }\n\n    // 支持自定义中间件\n    getKoa() {\n\n        return koahub.app;\n    }\n\n    handleError() {\n\n        // 监控错误日志\n        koahub.app.on(\"error\", function (err, ctx) {\n            captureDebug(err);\n        });\n\n        // 捕获promise reject错误\n        process.on('unhandledRejection', function (reason, promise) {\n            captureDebug(reason);\n        });\n\n        // 捕获未知错误\n        process.on('uncaughtException', function (err) {\n            captureDebug(err);\n        });\n    }\n\n    loadHttpMiddlewares() {\n\n        // 加载http中间件\n        koahub.app.use(httpMiddleware().skip(function (ctx) {\n\n            const path = ctx.path;\n            if (path == '/') {\n                return false;\n            }\n\n            // path验证，无效跳过中间件\n            const paths = path.substr(1, path.length).split('/');\n            if (paths[paths.length - 1].indexOf('.') != -1) {\n                return true;\n            }\n\n            // path验证, 无效跳转\n            let module = koahub.configs.index.default_module;\n            let controller = koahub.configs.index.default_controller;\n            let action = koahub.configs.index.default_action;\n\n            let url = '';\n            for (let key in paths) {\n                if (!paths[key]) {\n                    ctx.redirect(url);\n                    return true;\n                } else {\n                    url += '/' + paths[key];\n                }\n            }\n\n            return false;\n        }));\n    }\n\n    run(port) {\n\n        this.loadHttpMiddlewares();\n        this.handleError();\n\n        if (!port) {\n            port = koahub.configs.index.port;\n        }\n\n        if (this.server) {\n            this.server.listen(port, this.started(port));\n        } else {\n            this.getServer().listen(port, this.started(port));\n        }\n    }\n\n    started(port) {\n\n        this.loadWatcher(koahub.paths);\n\n        console.log(colors.green(`[Koahubjs] Koahubjs version: ${koahub.version}`));\n        console.log(colors.green(`[Koahubjs] Koahubjs website: http://js.koahub.com`));\n        console.log(colors.green(`[Koahubjs] Server running at http://127.0.0.1:${port}`));\n    }\n}"]}