{"version":3,"sources":["../src/index.js"],"names":["Koahub","global","koahub","undefined","app","init","configs","loader","index","merge","runtime","config","name","value","http","log","type","console","Date","rootPath","process","cwd","runtimePath","resolve","runtimeFile","argv","appName","appPath","appFile","relative","paths","runtimeName","key","use","restart","loadLoaders","loadConfigs","loadUtils","loadPaths","loadMiddlewares","server","Server","callback","on","err","ctx","reason","promise","message","indexOf","exit","next","hook","skip","path","test","port","loadHttpMiddlewares","handleError","start","startWatcher","listen","getServer","started","green","version"],"mappings":"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","file":"index.js","sourcesContent":["import path from \"path\";\nimport http from \"http\";\nimport Koa from \"koa\";\nimport lodash from \"lodash\";\nimport logger from \"koa-logger\";\nimport favicon from \"koa-favicon\";\nimport colors from \"colors/safe\";\nimport packageFile from \"./../package.json\";\nimport Loader from \"./lib/loader.class\";\nimport Hook from \"./lib/hook.class\";\nimport Http from \"./data/http.class\";\nimport Watcher from \"./lib/watcher.class\";\nimport config from \"./config/index.config\";\nimport {httpMiddleware} from \"./middleware/http.middleware\";\nimport {debug as captureDebug} from \"./util/log.util\";\nimport {dateFormat} from \"./util/time.util\";\n\nexport default class Koahub {\n\n    constructor() {\n\n        // 防止多次初始化丢失中间件\n        if (global.koahub == undefined) {\n\n            // 加载全局变量\n            global.koahub = packageFile;\n            // new Koa()\n            koahub.app = new Koa();\n\n            this.init();\n        } else {\n            this.init(true);\n        }\n    }\n\n    loadConfigs() {\n\n        // Object.assign({}, config) 创建新对象，不允许覆盖config\n        koahub.configs = new Loader(config.loader.configs);\n        koahub.configs.index = lodash.merge(Object.assign({}, config), koahub.configs.index);\n\n        // app, runtime不允许覆盖\n        koahub.configs.index.app = config.app;\n        koahub.configs.index.runtime = config.runtime;\n    }\n\n    loadUtils() {\n\n        // config函数\n        koahub.config = function (name, value) {\n            if (name == undefined) {\n                return koahub.configs.index;\n            } else {\n                if (value == undefined) {\n                    return koahub.configs.index[name];\n                } else {\n                    koahub.configs.index[name] = value;\n                }\n            }\n        };\n\n        // controller依赖http\n        koahub.http = Http;\n        // log 日志\n        koahub.log = function (log, type = 'log') {\n            if (typeof log == 'string') {\n                console[type](`[${dateFormat(new Date(), 'yyyy-MM-dd hh:mm:ss')}] [Koahubjs] ${log}`);\n            } else {\n                console[type](log);\n            }\n        }\n    }\n\n    loadPaths() {\n\n        const rootPath = process.cwd();\n        const runtime = koahub.config('runtime');\n        const runtimePath = path.resolve(rootPath, runtime);\n        const runtimeFile = process.argv[1];\n        const appName = koahub.config('app');\n        const appPath = path.resolve(rootPath, appName);\n        const appFile = path.resolve(appPath, path.relative(runtimePath, runtimeFile));\n\n        koahub.paths = {\n            rootPath: rootPath,\n            appName: appName,\n            appPath: appPath,\n            appFile: appFile,\n            runtimeName: runtime,\n            runtimePath: runtimePath,\n            runtimeFile: runtimeFile\n        };\n    }\n\n    loadLoaders() {\n\n        for (let key in koahub.config('loader')) {\n\n            // 移除configs重复加载\n            if (key == 'configs') {\n                continue;\n            }\n            koahub[key] = new Loader(koahub.config('loader')[key]);\n        }\n    }\n\n    loadMiddlewares() {\n\n        // log middleware\n        if (koahub.config('logger')) {\n            koahub.app.use(logger());\n        }\n\n        // favicon middleware\n        koahub.app.use(favicon(koahub.config('favicon')));\n    }\n\n    init(restart = false) {\n\n        // 自动加载重启\n        if (restart) {\n\n            this.loadLoaders();\n        } else {\n\n            this.loadConfigs();\n            this.loadUtils();\n            this.loadPaths();\n            this.loadLoaders();\n            this.loadMiddlewares();\n        }\n    }\n\n    // 支持soket.io\n    getServer() {\n\n        const server = http.Server(koahub.app.callback());\n        return this.server = server;\n    }\n\n    // 支持自定义中间件\n    getKoa() {\n\n        return koahub.app;\n    }\n\n    handleError() {\n\n        // 监控错误日志\n        koahub.app.on(\"error\", function (err, ctx) {\n            captureDebug(err);\n        });\n\n        // 捕获promise reject错误\n        process.on('unhandledRejection', function (reason, promise) {\n            captureDebug(reason);\n        });\n\n        // 捕获未知错误\n        process.on('uncaughtException', function (err) {\n            captureDebug(err);\n\n            if (err.message.indexOf(' EADDRINUSE ') > -1) {\n                process.exit(0);\n            }\n        });\n    }\n\n    loadHttpMiddlewares() {\n\n        // 加载hook中间件\n        if (koahub.config('hook')) {\n            koahub.app.use(async function (ctx, next) {\n                koahub.hook = new Hook(ctx, next);\n                await next();\n            });\n        }\n\n        // 加载http中间件\n        koahub.app.use(httpMiddleware().skip(function (ctx) {\n\n            const path = ctx.path;\n\n            // path验证，资源文件跳过中间件\n            if (/[^\\/]+\\.+\\w+$/.test(path)) {\n                return true;\n            }\n\n            // path验证，无效跳过中间件\n            if (/\\/\\//.test(path)) {\n                return true;\n            }\n\n            return false;\n        }));\n    }\n\n    run(port) {\n\n        this.loadHttpMiddlewares();\n        this.handleError();\n\n        if (!port) {\n            port = koahub.config('port');\n        }\n\n        this.start(port);\n    }\n\n    start(port) {\n\n        // 文件监控\n        this.startWatcher();\n\n        if (this.server) {\n            this.server.listen(port);\n        } else {\n            this.getServer().listen(port);\n        }\n\n        this.started(port);\n    }\n\n    startWatcher() {\n\n        if (koahub.config('watcher')) {\n            new Watcher(koahub.paths);\n        }\n    }\n\n    started(port) {\n\n        koahub.log(colors.green(`Koahubjs version: ${koahub.version}`));\n        koahub.log(colors.green(`Koahubjs website: http://js.koahub.com`));\n        koahub.log(colors.green(`Server Debug Status: ${koahub.config('debug')}`));\n        koahub.log(colors.green(`Server File Watcher: ${koahub.config('watcher')}`));\n        koahub.log(colors.green(`Server running at http://127.0.0.1:${port}`));\n    }\n}"]}