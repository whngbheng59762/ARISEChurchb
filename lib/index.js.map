{"version":3,"sources":["../src/index.js"],"names":["global","koahub","undefined","loadPaths","app_path","app","appName","mainFile","process","argv","mainPath","dirname","appPath","resolve","paths","http","controllers","loader","controller","hook","utils","util","models","model","configs","config","default","log_on","use","loadControllers","loadModels","loadUtils","loadConfigs","loadHooks","loadMiddlewares","ctx","next","path","server","Server","callback","port","init","listen","getServer","console","log"],"mappings":";;;;;;;;;;;;;;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;AAII,sBAAc;AAAA;;;AAEV,YAAIA,OAAOC,MAAP,IAAiBC,SAArB,EAAgC;AAC5B;AACAF,mBAAOC,MAAP,GAAgB,EAAhB;AACH;;AAED,aAAKE,SAAL,CAAe,kBAAOC,QAAtB;;AAEA;AACA,YAAMC,MAAM,mBAAZ;;AAEAJ,eAAOI,GAAP,GAAaA,GAAb;AACH;;;;kCAESC,O,EAAS;;AAEf,gBAAIC,WAAWC,QAAQC,IAAR,CAAa,CAAb,CAAf;AACA,gBAAIC,WAAW,eAAKC,OAAL,CAAaJ,QAAb,CAAf;AACA,gBAAIK,UAAU,eAAKC,OAAL,CAAaH,QAAb,EAAuBJ,OAAvB,CAAd;;AAEAL,mBAAOa,KAAP,GAAe;AACXP,0BAAUA,QADC;AAEXG,0BAAUA,QAFC;AAGXJ,yBAASA,OAHE;AAIXM,yBAASA;AAJE,aAAf;AAMH;;;0CAEiB;AACd;AACAX,mBAAOc,IAAP;AACAd,mBAAOe,WAAP,GAAqB,qBAAW,kBAAOC,MAAP,CAAcC,UAAzB,CAArB;AACH;;;oCAEW;AACRjB,mBAAOkB,IAAP,GAAc,oBAAd;AACH;;;oCAEW;AACRlB,mBAAOmB,KAAP,GAAe,qBAAW,kBAAOH,MAAP,CAAcI,IAAzB,CAAf;AACH;;;qCAEY;AACTpB,mBAAOqB,MAAP,GAAgB,qBAAW,kBAAOL,MAAP,CAAcM,KAAzB,CAAhB;AACH;;;sCAEa;AACVtB,mBAAOuB,OAAP,GAAiB,qBAAW,kBAAOP,MAAP,CAAcQ,MAAzB,CAAjB;AACAxB,mBAAOuB,OAAP,CAAeE,OAAf,GAAyB,yCAAsBzB,OAAOuB,OAAP,CAAeE,OAArC,CAAzB;AACH;;;0CAEiB;AACd,gBAAIzB,OAAOuB,OAAP,CAAeE,OAAf,CAAuBC,MAA3B,EAAmC;AAC/B1B,uBAAOI,GAAP,CAAWuB,GAAX,CAAe,0BAAf;AACH;AACJ;;;+BAEM;AACH,iBAAKC,eAAL;AACA,iBAAKC,UAAL;AACA,iBAAKC,SAAL;AACA,iBAAKC,WAAL;AACA,iBAAKC,SAAL;AACA,iBAAKC,eAAL;;AAEAjC,mBAAOI,GAAP,CAAWuB,GAAX,CAAe,UAAUO,GAAV,EAAeC,IAAf,EAAqB;;AAEhCnC,uBAAOkC,GAAP,GAAaA,GAAb;;AAEA;AACAnC,uBAAOmC,GAAP,GAAaA,GAAb;;AAEA,yCAAUA,IAAIE,IAAd;AACH,aARD;AASH;;AAED;;;;oCACY;AACR,gBAAMC,SAAS,eAAKC,MAAL,CAAYtC,OAAOI,GAAP,CAAWmC,QAAX,EAAZ,CAAf;AACA,mBAAO,KAAKF,MAAL,GAAcA,MAArB;AACH;;AAED;;;;iCACS;AACL,mBAAOrC,OAAOI,GAAd;AACH;;;8BAEuB;AAAA,gBAApBoC,IAAoB,uEAAb,kBAAOA,IAAM;;;AAEpB,iBAAKC,IAAL;;AAEA,gBAAI,KAAKJ,MAAT,EAAiB;AACb,qBAAKA,MAAL,CAAYK,MAAZ,CAAmBF,IAAnB;AACH,aAFD,MAEO;AACH,qBAAKG,SAAL,GAAiBD,MAAjB,CAAwBF,IAAxB;AACH;;AAEDI,oBAAQC,GAAR,yCAAkDL,IAAlD;AACH","file":"index.js","sourcesContent":["import path from \"path\";\nimport http from \"http\";\nimport Koa from \"koa\";\nimport logger from \"koa-logger\";\nimport Loader from \"./lib/loader.class\";\nimport Http from \"./data/http.class\";\nimport Hook from \"./lib/hook.class\";\nimport config from \"./config/default.config\";\nimport {runAction} from \"./util/default.util\";\n\nexport default class {\n\n    constructor() {\n\n        if (global.koahub == undefined) {\n            // 加载全局变量\n            global.koahub = {};\n        }\n\n        this.loadPaths(config.app_path);\n\n        // new Koa()\n        const app = new Koa();\n\n        koahub.app = app;\n    }\n\n    loadPaths(appName) {\n\n        let mainFile = process.argv[1];\n        let mainPath = path.dirname(mainFile);\n        let appPath = path.resolve(mainPath, appName);\n\n        koahub.paths = {\n            mainFile: mainFile,\n            mainPath: mainPath,\n            appName: appName,\n            appPath: appPath\n        };\n    }\n\n    loadControllers() {\n        // controller依赖http\n        koahub.http = Http;\n        koahub.controllers = new Loader(config.loader.controller);\n    }\n\n    loadHooks() {\n        koahub.hook = new Hook();\n    }\n\n    loadUtils() {\n        koahub.utils = new Loader(config.loader.util);\n    }\n\n    loadModels() {\n        koahub.models = new Loader(config.loader.model);\n    }\n\n    loadConfigs() {\n        koahub.configs = new Loader(config.loader.config);\n        koahub.configs.default = Object.assign(config, koahub.configs.default);\n    }\n\n    loadMiddlewares() {\n        if (koahub.configs.default.log_on) {\n            koahub.app.use(logger());\n        }\n    }\n\n    init() {\n        this.loadControllers();\n        this.loadModels();\n        this.loadUtils();\n        this.loadConfigs();\n        this.loadHooks();\n        this.loadMiddlewares();\n\n        koahub.app.use(function (ctx, next) {\n\n            koahub.ctx = ctx;\n\n            // 快捷方法\n            global.ctx = ctx;\n\n            runAction(ctx.path);\n        });\n    }\n\n    // 支持soket.io\n    getServer() {\n        const server = http.Server(koahub.app.callback());\n        return this.server = server;\n    }\n\n    // 支持自定义中间件\n    getKoa() {\n        return koahub.app;\n    }\n\n    run(port = config.port) {\n\n        this.init();\n\n        if (this.server) {\n            this.server.listen(port);\n        } else {\n            this.getServer().listen(port);\n        }\n\n        console.log(`server running at http://127.0.0.1:${port}`);\n    }\n}\n"]}