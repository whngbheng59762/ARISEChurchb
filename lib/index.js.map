{"version":3,"sources":["../src/index.js"],"names":["global","koahub","undefined","merge","app","init","appName","mainFile","process","argv","mainPath","dirname","appPath","resolve","paths","http","controllers","loader","controller","hook","utils","util","lodash","models","model","configs","config","index","log_on","use","favicon","loadConfigs","loadPaths","app_path","loadControllers","loadModels","loadUtils","loadHooks","loadMiddlewares","server","Server","callback","on","err","ctx","reason","promise","next","skip","path","substr","length","split","indexOf","port","loadHttpMiddlewares","handleError","listen","getServer","console","log","version"],"mappings":"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","file":"index.js","sourcesContent":["import path from \"path\";\nimport http from \"http\";\nimport packageFile from \"./../package.json\";\nimport Koa from \"koa\";\nimport logger from \"koa-logger\";\nimport favicon from \"koa-favicon\";\nimport lodash from \"lodash\";\nimport Loader from \"./lib/loader.class\";\nimport Http from \"./data/http.class\";\nimport Hook from \"./lib/hook.class\";\nimport config from \"./config/index.config\";\nimport {httpMiddleware} from \"./middleware/http.middleware\";\nimport debug from \"./util/debug.util\";\n\nexport default class {\n\n    constructor() {\n\n        if (global.koahub == undefined) {\n            // 加载全局变量\n            global.koahub = lodash.merge({}, packageFile);\n        }\n\n        // new Koa()\n        const app = new Koa();\n\n        koahub.app = app;\n\n        this.init();\n    }\n\n    loadPaths(appName) {\n\n        let mainFile = process.argv[1];\n        let mainPath = path.dirname(mainFile);\n        let appPath = path.resolve(mainPath, appName);\n\n        koahub.paths = {\n            mainFile: mainFile,\n            mainPath: mainPath,\n            appName: appName,\n            appPath: appPath\n        };\n    }\n\n    loadControllers() {\n\n        // controller依赖http\n        koahub.http = Http;\n        koahub.controllers = new Loader(config.loader.controller);\n    }\n\n    loadHooks() {\n\n        koahub.hook = new Hook();\n    }\n\n    loadUtils() {\n\n        koahub.utils = new Loader(config.loader.util);\n        koahub.utils.lodash = lodash;\n    }\n\n    loadModels() {\n\n        koahub.models = new Loader(config.loader.model);\n    }\n\n    loadConfigs() {\n\n        koahub.configs = new Loader(config.loader.config);\n        koahub.configs.index = Object.assign(config, koahub.configs.index);\n    }\n\n    loadMiddlewares() {\n\n        // log middleware\n        if (koahub.configs.index.log_on) {\n            koahub.app.use(logger());\n        }\n\n        // favicon middleware\n        koahub.app.use(favicon(koahub.configs.index.favicon));\n    }\n\n    init() {\n\n        this.loadConfigs();\n        // 加载路径变量 依赖config\n        this.loadPaths(koahub.configs.index.app_path);\n        this.loadControllers();\n        this.loadModels();\n        this.loadUtils();\n        this.loadHooks();\n        this.loadMiddlewares();\n    }\n\n    // 支持soket.io\n    getServer() {\n\n        const server = http.Server(koahub.app.callback());\n        return this.server = server;\n    }\n\n    // 支持自定义中间件\n    getKoa() {\n\n        return koahub.app;\n    }\n\n    handleError() {\n\n        // 监控错误日志\n        koahub.app.on(\"error\", function (err, ctx) {\n            debug(err);\n        });\n\n        // 捕获promise reject错误\n        process.on('unhandledRejection', function (reason, promise) {\n            debug(reason);\n        });\n\n        // 捕获未知错误\n        process.on('uncaughtException', function (err) {\n            debug(err);\n        });\n    }\n\n    loadHttpMiddlewares() {\n\n        // 全局ctx快捷方法\n        koahub.app.use(async function (ctx, next) {\n\n            koahub.ctx = ctx;\n\n            // 快捷方法\n            global.ctx = ctx;\n\n            await next();\n        });\n\n        // 加载http中间件\n        koahub.app.use(httpMiddleware().skip(function () {\n\n            const path = koahub.ctx.path;\n            if (path == '/') {\n                return false;\n            }\n\n            const paths = path.substr(1, path.length).split('/');\n            if (paths[paths.length - 1].indexOf('.') != -1) {\n                return true;\n            }\n            return false;\n        }));\n    }\n\n    run(port) {\n\n        this.loadHttpMiddlewares();\n        this.handleError();\n\n        if (!port) {\n            port = koahub.configs.index.port;\n        }\n\n        if (this.server) {\n            this.server.listen(port);\n        } else {\n            this.getServer().listen(port);\n        }\n\n        console.log(`[Koahubjs] Koahubjs version: ${koahub.version}`);\n        console.log(`[Koahubjs] Koahubjs website: http://js.koahub.com`);\n        console.log(`[Koahubjs] Server running at http://127.0.0.1:${port}`);\n    }\n}\n"]}