{"version":3,"sources":["../src/index.js"],"names":["global","Promise","require","default","Koahub","options","koahub","koa","init","on","err","ctx","process","reason","promise","message","indexOf","exit","root","env","ROOT","cwd","app","resolve","APP","paths","configs","loader","merge","config","name","value","undefined","controller","key","loadModules","modules","controllers","split","length","push","union","use","isString","Error","isPlainObject","isBoolean","dir","loadErrors","loadPaths","loadConfigs","loadUtils","loadLoaders","loadMiddlewares","fn","server","Server","callback","next","request","body","files","post","fields","file","skip","path","urlSuffix","regexp","RegExp","test","substr","lastIndexOf","port","loadHttpMiddlewares","start","listen","getServer","started","version","NODE_ENV"],"mappings":"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","file":"index.js","sourcesContent":["import Koa from \"koa\";\nimport http from \"http\";\nimport path from \"path\";\nimport body from \"koa-body\";\nimport cors from \"koa-cors\";\nimport lodash from \"lodash\";\nimport logger from \"koa-logger\";\nimport convert from \"koa-convert\";\nimport favicon from \"koa-favicon\";\nimport session from \"koa-session2\";\nimport staticCache from \"koa-static-cache\";\nimport packageFile from \"./../package.json\";\nimport Loader from \"./lib/loader.class\";\nimport Controller from \"./lib/controller.class\";\nimport config from \"./config/default.config\";\nimport httpMiddleware from \"./middleware/http.middleware\";\nimport log from \"./util/log.util\";\nimport {isGeneratorFunction, expressMiddlewareToKoaMiddleware} from \"./util/default.util\";\n\n//rewite promise, bluebird is more faster\nglobal.Promise = require('bluebird');\nrequire('babel-runtime/core-js/promise').default = Promise;\n\nexport default class Koahub {\n\n    constructor(options = {}) {\n\n        // 加载全局变量\n        global.koahub = packageFile;\n\n        // new Koa()\n        this.koa = new Koa();\n        this.options = options;\n        this.init();\n    }\n\n    loadErrors() {\n\n        // 监控错误日志\n        this.koa.on(\"error\", function (err, ctx) {\n            log(err);\n        });\n\n        // 捕获promise reject错误\n        process.on('unhandledRejection', function (reason, promise) {\n            log(reason);\n        });\n\n        // 捕获未知错误\n        process.on('uncaughtException', function (err) {\n            log(err);\n\n            if (err.message.indexOf(' EADDRINUSE ') > -1) {\n                process.exit();\n            }\n        });\n    }\n\n    loadPaths() {\n\n        const root = this.options.root || process.env.ROOT || process.cwd();\n        const app = path.resolve(root, this.options.app || process.env.APP || 'app');\n\n        koahub.paths = {\n            app: app,\n            root: root\n        };\n    }\n\n    loadConfigs() {\n\n        // Object.assign({}, config) 创建新对象，不允许覆盖config\n        koahub.configs = new Loader(koahub.paths.app, config.loader.configs);\n        koahub.configs.default = lodash.merge(Object.assign({}, config), koahub.configs.default);\n    }\n\n    loadUtils() {\n\n        // config函数\n        koahub.config = function (name, value) {\n            if (name == undefined) {\n                return koahub.configs.default;\n            } else {\n                if (value == undefined) {\n                    return koahub.configs.default[name];\n                } else {\n                    koahub.configs.default[name] = value;\n                }\n            }\n        };\n\n        // controller继承\n        koahub.controller = Controller;\n    }\n\n    loadLoaders() {\n\n        for (let key in koahub.config('loader')) {\n\n            // 移除configs重复加载\n            if (key == 'configs') {\n                continue;\n            }\n            koahub[key] = new Loader(koahub.paths.app, koahub.config('loader')[key]);\n        }\n\n        // 加载模块\n        this.loadModules();\n    }\n\n    loadModules() {\n\n        let modules = [];\n        for (let key in koahub.controllers) {\n            let paths = key.split('/');\n            if (paths.length < 3) {\n                continue;\n            }\n            modules.push(paths[1]);\n        }\n        koahub.modules = lodash.union(modules);\n    }\n\n    loadMiddlewares() {\n\n        // log middleware\n        if (koahub.config('logger')) {\n            this.use(logger());\n        }\n\n        // favicon middleware\n        if (koahub.config('favicon')) {\n            if (lodash.isString(koahub.config('favicon'))) {\n                this.use(favicon(koahub.config('favicon')));\n            } else {\n                throw new Error('Favicon must be a path');\n            }\n        }\n\n        // cors middleware\n        if (koahub.config('cors')) {\n            if (lodash.isPlainObject(koahub.config('cors'))) {\n                this.use(cors(koahub.config('cors')));\n            } else {\n                if (lodash.isBoolean(koahub.config('cors'))) {\n                    this.use(cors());\n                } else {\n                    throw new Error('Cors must be a PlainObject or Boolean');\n                }\n            }\n        }\n\n        // session middleware\n        if (koahub.config('session')) {\n            if (lodash.isPlainObject(koahub.config('session'))) {\n                this.use(session(koahub.config('session')));\n            } else {\n                if (lodash.isBoolean(koahub.config('session'))) {\n                    this.use(session());\n                } else {\n                    throw new Error('Session must be a PlainObject or Boolean');\n                }\n            }\n        }\n\n        // static middleware\n        if (koahub.config('static')) {\n            if (lodash.isPlainObject(koahub.config('static'))) {\n                const {dir = '', options = {}} = koahub.config('static');\n                this.use(staticCache(dir, options));\n            } else {\n                throw new Error('Static must be a PlainObject');\n            }\n        }\n    }\n\n    init() {\n\n        this.loadErrors();\n        this.loadPaths();\n        this.loadConfigs();\n        this.loadUtils();\n        this.loadLoaders();\n        this.loadMiddlewares();\n    }\n\n    // 默认支持koa middleware\n    use(fn) {\n\n        if (isGeneratorFunction(fn)) {\n            fn = convert(fn);\n        }\n        this.koa.use(fn);\n    }\n\n    // 支持express middleware\n    useExpress(fn) {\n\n        fn = expressMiddlewareToKoaMiddleware(fn);\n        this.koa.use(fn);\n    }\n\n    // 支持soket.io\n    getServer() {\n\n        const server = http.Server(this.koa.callback());\n        return this.server = server;\n    }\n\n    // 支持自定义中间件\n    getKoa() {\n\n        return this.koa;\n    }\n\n    loadHttpMiddlewares() {\n\n        // 加载body中间件\n        if (koahub.config('body')) {\n            if (lodash.isPlainObject(koahub.config('body'))) {\n\n                this.use(body(koahub.config('body')));\n                this.use(async function (ctx, next) {\n                    if (!ctx.request.body.files) {\n                        ctx.post = ctx.request.body;\n                    } else {\n                        ctx.post = ctx.request.body.fields;\n                        ctx.file = ctx.request.body.files;\n                    }\n                    await next();\n                });\n            } else {\n                throw new Error('Body options must be a PlainObject');\n            }\n        }\n\n        // 加载http中间件\n        this.use(httpMiddleware().skip(function (ctx) {\n\n            const path = ctx.path;\n            const urlSuffix = koahub.config('url_suffix');\n\n            if (urlSuffix) {\n                const regexp = new RegExp(`${urlSuffix}$`);\n                if (regexp.test(path)) {\n                    ctx.path = path.substr(0, path.lastIndexOf(urlSuffix));\n                    return false;\n                }\n                return true;\n            }\n\n            // path验证，资源文件跳过中间件\n            if (/[^\\/]+\\.+\\w+$/.test(path)) {\n                return true;\n            }\n\n            // path验证，无效跳过中间件\n            if (/\\/\\//.test(path)) {\n                return true;\n            }\n\n            return false;\n        }));\n    }\n\n    run(port) {\n\n        this.loadHttpMiddlewares();\n\n        if (!port) {\n            port = koahub.config('port');\n        }\n\n        this.start(port);\n    }\n\n    start(port) {\n\n        if (this.server) {\n            this.server.listen(port);\n        } else {\n            this.getServer().listen(port);\n        }\n\n        this.started(port);\n    }\n\n    started(port) {\n\n        log(`Koahub Version: ${koahub.version}`);\n        log(`Koahub Website: http://js.koahub.com`);\n        log(`Server Enviroment: ${process.env.NODE_ENV || 'development'}`);\n        log(`Server running at: http://127.0.0.1:${port}`);\n    }\n}"]}