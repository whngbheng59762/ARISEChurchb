{"version":3,"sources":["../src/index.js"],"names":["appName","global","koahub","undefined","config","loader","loadPaths","app","mainFile","process","argv","mainPath","dirname","appPath","resolve","paths","http","controllers","controller","hook","utils","util","models","model","configs","loadControllers","loadModels","loadUtils","loadConfigs","loadHooks","use","ctx","next","path","action","slice","lastIndexOf","include","key","ctrl","pros","prototype","filter","value","callFlag","k","call","throw","port","init","listen","console","log"],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAAA;;;;AACA;;;;AAEA;;;;AACA;;;;AACA;;;;AACA;;;;;;;AAII,sBAA6B;AAAA,YAAjBA,OAAiB,uEAAP,KAAO;AAAA;;;AAEzB,YAAIC,OAAOC,MAAP,IAAiBC,SAArB,EAAgC;AAC5B;AACAF,mBAAOC,MAAP,GAAgB,EAAhB;AACH;;AAED,aAAKE,MAAL,GAAc,iBAAOC,MAAP,CAAcL,OAAd,CAAd;;AAEA,aAAKM,SAAL,CAAeN,OAAf;;AAEA;AACA,YAAMO,MAAM,mBAAZ;;AAEAL,eAAOK,GAAP,GAAaA,GAAb;AACH;;;;kCAESP,O,EAAS;;AAEf,gBAAIQ,WAAWC,QAAQC,IAAR,CAAa,CAAb,CAAf;AACA,gBAAIC,WAAW,eAAKC,OAAL,CAAaJ,QAAb,CAAf;AACA,gBAAIK,UAAU,eAAKC,OAAL,CAAaH,QAAb,EAAuBX,OAAvB,CAAd;;AAEAE,mBAAOa,KAAP,GAAe;AACXP,0BAAUA,QADC;AAEXG,0BAAUA,QAFC;AAGXX,yBAASA,OAHE;AAIXa,yBAASA;AAJE,aAAf;AAMH;;;0CAEiB;AACd;AACAX,mBAAOc,IAAP;AACAd,mBAAOe,WAAP,GAAqB,qBAAW,KAAKb,MAAL,CAAYc,UAAvB,CAArB;AACH;;;oCAEW;AACRhB,mBAAOiB,IAAP,GAAc,oBAAd;AACH;;;oCAEW;AACRjB,mBAAOkB,KAAP,GAAe,qBAAW,KAAKhB,MAAL,CAAYiB,IAAvB,CAAf;AACH;;;qCAEY;AACTnB,mBAAOoB,MAAP,GAAgB,qBAAW,KAAKlB,MAAL,CAAYmB,KAAvB,CAAhB;AACH;;;sCAEa;AACVrB,mBAAOsB,OAAP,GAAiB,qBAAW,KAAKpB,MAAL,CAAYA,MAAvB,CAAjB;AACH;;;+BAEM;AACH,iBAAKqB,eAAL;AACA,iBAAKC,UAAL;AACA,iBAAKC,SAAL;AACA,iBAAKC,WAAL;AACA,iBAAKC,SAAL;;AAEA3B,mBAAOK,GAAP,CAAWuB,GAAX,CAAe,UAASC,GAAT,EAAcC,IAAd,EAAoB;;AAE/B9B,uBAAO6B,GAAP,GAAaA,GAAb;;AAEA;AACA9B,uBAAO8B,GAAP,GAAaA,GAAb;;AAEA,oBAAIE,OAAOF,IAAIE,IAAf;AACA,oBAAIC,SAASD,KAAKE,KAAL,CAAWF,KAAKG,WAAL,CAAiB,GAAjB,CAAX,CAAb;;AAEAH,uBAAOA,KAAKE,KAAL,CAAW,CAAX,EAAcF,KAAKG,WAAL,CAAiB,GAAjB,CAAd,CAAP;;AAEA,oBAAIC,UAAU,KAAd;AACA,qBAAK,IAAIC,GAAT,IAAgBpC,OAAOe,WAAvB,EAAoC;AAChC,wBAAIqB,OAAOL,IAAX,EAAiB;AACbI,kCAAU,IAAV;AACA;AACH;AACJ;;AAED,oBAAIA,OAAJ,EAAa;AACT,wBAAIE,OAAOrC,OAAOe,WAAP,CAAmBgB,IAAnB,CAAX;AACA,wBAAIO,OAAO,mCAA2BD,KAAKE,SAAhC,EAA2CC,MAA3C,CAAkD,UAASC,KAAT,EAAgB;AACzE,4BAAIA,SAAS,aAAb,EAA4B;AACxB,mCAAO,KAAP;AACH;AACD,+BAAO,IAAP;AACH,qBALU,CAAX;;AAOA,wBAAIC,WAAW,IAAf;AACA,yBAAK,IAAIC,CAAT,IAAcL,IAAd,EAAoB;AAChB,4BAAI,MAAMA,KAAKK,CAAL,CAAN,IAAiBX,MAArB,EAA6B;AACzB,0DAAsB,IAAIK,IAAJ,EAAtB,EAAkCC,KAAKK,CAAL,CAAlC,EAA2CC,IAA3C,CAAgD,IAAhD;AACAF,uCAAW,KAAX;AACH;AACJ;;AAED,wBAAIA,QAAJ,EAAc;AACVb,4BAAIgB,KAAJ,CAAU,GAAV,EAAe,kBAAf;AACH;AACJ,iBApBD,MAoBO;AACHhB,wBAAIgB,KAAJ,CAAU,GAAV,EAAe,sBAAf;AACH;AACJ,aA3CD;AA4CH;;AAED;;;;iCACS;AACL,mBAAO7C,OAAOK,GAAd;AACH;;;8BAEgB;AAAA,gBAAbyC,IAAa,uEAAN,IAAM;;;AAEb,iBAAKC,IAAL;;AAEA/C,mBAAOK,GAAP,CAAW2C,MAAX,CAAkBF,IAAlB;;AAEAG,oBAAQC,GAAR,yCAAkDJ,IAAlD;AACH","file":"index.js","sourcesContent":["import Koa from \"koa\";\nimport path from \"path\";\n\nimport Loader from \"./lib/loader.class\";\nimport Http from \"./data/http.class\";\nimport Config from \"./config/config.class\";\nimport Hook from \"./lib/hook.class\";\n\nexport default class {\n\n    constructor(appName = 'app') {\n\n        if (global.koahub == undefined) {\n            // 加载全局变量\n            global.koahub = {};\n        }\n\n        this.config = Config.loader(appName);\n\n        this.loadPaths(appName);\n\n        // new Koa()\n        const app = new Koa();\n\n        koahub.app = app;\n    }\n\n    loadPaths(appName) {\n\n        let mainFile = process.argv[1];\n        let mainPath = path.dirname(mainFile);\n        let appPath = path.resolve(mainPath, appName);\n\n        koahub.paths = {\n            mainFile: mainFile,\n            mainPath: mainPath,\n            appName: appName,\n            appPath: appPath\n        };\n    }\n\n    loadControllers() {\n        // controller依赖http\n        koahub.http = Http;\n        koahub.controllers = new Loader(this.config.controller);\n    }\n\n    loadHooks() {\n        koahub.hook = new Hook();\n    }\n\n    loadUtils() {\n        koahub.utils = new Loader(this.config.util);\n    }\n\n    loadModels() {\n        koahub.models = new Loader(this.config.model);\n    }\n\n    loadConfigs() {\n        koahub.configs = new Loader(this.config.config);\n    }\n\n    init() {\n        this.loadControllers();\n        this.loadModels();\n        this.loadUtils();\n        this.loadConfigs();\n        this.loadHooks();\n\n        koahub.app.use(function(ctx, next) {\n\n            koahub.ctx = ctx;\n\n            // 快捷方法\n            global.ctx = ctx;\n\n            let path = ctx.path;\n            let action = path.slice(path.lastIndexOf('/'));\n\n            path = path.slice(0, path.lastIndexOf('/'));\n\n            let include = false;\n            for (let key in koahub.controllers) {\n                if (key == path) {\n                    include = true;\n                    break;\n                }\n            }\n\n            if (include) {\n                let ctrl = koahub.controllers[path];\n                let pros = Object.getOwnPropertyNames(ctrl.prototype).filter(function(value) {\n                    if (value == 'constructor') {\n                        return false;\n                    }\n                    return true;\n                });\n\n                var callFlag = true;\n                for (let k in pros) {\n                    if ('/' + pros[k] == action) {\n                        Object.getPrototypeOf(new ctrl())[pros[k]].call(this);\n                        callFlag = false;\n                    }\n                }\n\n                if (callFlag) {\n                    ctx.throw(404, 'Not Found Method');\n                }\n            } else {\n                ctx.throw(404, 'Not Found Controller');\n            }\n        });\n    }\n\n    // 支持自定义中间件\n    getKoa() {\n        return koahub.app;\n    }\n\n    run(port = 3000) {\n\n        this.init();\n\n        koahub.app.listen(port);\n\n        console.log(`server running at http://127.0.0.1:${port}`);\n    }\n}\n"]}