{"version":3,"sources":["../../src/cli/koahub.js"],"names":["isFileSync","path","existsSync","statSync","isFile","fileCopySync","src","dest","writeFileSync","readFileSync","version","command","description","option","action","script","options","join","app","regExpJs","RegExp","test","regExp","Error","rootPath","process","cwd","appName","appPath","resolve","appFile","runtimeName","runtime","runtimePath","runtimeFile","replace","watch","startRuntimeProcess","runtimeProcess","fork","on","code","EADDRINUSE","exit","NORMAL","compile","exec","send","SIGINT","err","file","fileRuntimePath","require","name","destFile","srcFile","mainModule","filename","project","renameSync","parse","argv","args","length","help"],"mappings":"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","file":"koahub.js","sourcesContent":["import program from \"commander\";\nimport path from \"path\";\nimport fs from \"fs\";\nimport child_process from \"child_process\";\nimport shell from \"shelljs\";\nimport watcher from \"./../util/watcher.util\";\nimport {EXITCODE} from \"./../util/exit.util\";\nimport config from \"./../config/index.config\";\n\nfunction isFileSync(path) {\n    return fs.existsSync(path) && fs.statSync(path).isFile();\n}\n\nfunction fileCopySync(src, dest) {\n    fs.writeFileSync(dest, fs.readFileSync(src));\n}\n\nprogram\n    .version('1.0.0')\n\nprogram\n    .command('start [script]')\n    .description('koahub start script --watch --compile')\n    .option('-w, --watch', 'auto restart when a file is modified')\n    .option('-c, --compile', 'auto babel process when a file is modified')\n    .action(function (script, options) {\n\n        if (!script) {\n            script = path.join(config.app, 'index.js');\n        }\n\n        const regExpJs = new RegExp(`.js$`);\n        if (!regExpJs.test(script)) {\n            script = path.join(script, 'index.js');\n        }\n\n        const regExp = new RegExp(`^${config.app}/?`);\n        if (!regExp.test(script)) {\n            throw new Error('Project directory and the runtime directory can\\'t be modified');\n        }\n\n        if (!isFileSync(script)) {\n            throw new Error('The `script` is not found.');\n        }\n\n        const rootPath = process.cwd();\n        const appName = config.app;\n        const appPath = path.resolve(rootPath, appName);\n        const appFile = path.resolve(rootPath, script);\n        const runtimeName = config.runtime;\n        const runtimePath = path.resolve(rootPath, runtimeName);\n        const runtimeFile = path.resolve(rootPath, script.replace(`${appName}/`, `${runtimeName}/`));\n\n        // 监控启动\n        if (options.watch === true) {\n\n            // 编译并且监控启动\n            if (options.compile === true) {\n                shell.exec(`./node_modules/.bin/babel ${appName}/ --out-dir ${runtimeName}/`);\n            }\n\n            let runtimeProcess;\n\n            function startRuntimeProcess(runtimeFile) {\n                runtimeProcess = child_process.fork(runtimeFile);\n                runtimeProcess.on('exit', function (code) {\n                    if (code == EXITCODE.EADDRINUSE) {\n                        process.exit(EXITCODE.NORMAL);\n                    }\n                    if (code == EXITCODE.NORMAL) {\n                        startRuntimeProcess(runtimeFile);\n                    }\n                });\n            }\n\n            // 启动运行时进程\n            startRuntimeProcess(runtimeFile);\n\n            // 监听进程退出，通知运行时进程退出\n            process.on('SIGINT', function () {\n                runtimeProcess.send('exit');\n                process.exit(EXITCODE.SIGINT);\n            });\n\n            // 捕获未知错误\n            process.on('uncaughtException', function (err) {\n                if (err) throw err;\n                runtimeProcess.send('exit');\n                startRuntimeProcess(runtimeFile);\n            });\n\n            // 开启文件监控\n            watcher(function (file, compile = true) {\n                // 进程退出\n                runtimeProcess.send('exit');\n                // 编译并且监控启动\n                if (options.compile === true && compile === true) {\n                    const fileRuntimePath = file.replace(`${appName}/`, `${runtimeName}/`);\n                    shell.exec(`./node_modules/.bin/babel ${file} --out-file ${fileRuntimePath}`);\n                }\n            });\n\n            return;\n        }\n\n        // 直接编译启动\n        if (options.compile === true) {\n            shell.exec(`./node_modules/.bin/babel ${appName}/ --out-dir ${runtimeName}/`);\n        }\n\n        // 直接启动\n        require(runtimeFile);\n    });\n\nprogram\n    .command('controller [name]')\n    .description('koahub create controller')\n    .action(function (name) {\n\n        const destFile = path.resolve(config.app, `controller/${name}.controller.js`);\n        const srcFile = path.resolve(process.mainModule.filename, '../../', 'template/controller/index.controller.js');\n\n        fileCopySync(srcFile, destFile);\n    });\n\nprogram\n    .command('create [project]')\n    .description('koahub create project')\n    .action(function (project) {\n\n        shell.exec('git clone https://github.com/einsqing/koahubjs-demo.git');\n        fs.renameSync(path.resolve('koahubjs-demo'), path.resolve(project));\n    });\n\nprogram.parse(process.argv);\n\nif (!program.args.length) program.help();"]}