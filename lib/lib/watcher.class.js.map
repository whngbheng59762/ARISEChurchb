{"version":3,"sources":["../../src/lib/watcher.class.js"],"names":["paths","watcher","watch","appPath","ignored","persistent","startTime","Date","on","_path","stats","relativePath","relative","rootPath","runtimePath","replace","appName","runtimeName","now","restart","masterSend","unlink","type","file","koahub","config","id","workers","send","name","setTimeout","msg"],"mappings":";;;;;;;;;;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;AACA;;;;;AAII,sBAAwB;AAAA;;AAAA,YAAZA,KAAY,uEAAJ,EAAI;AAAA;;;AAEpB,YAAMC,UAAU,mBAASC,KAAT,CAAeF,MAAMG,OAArB,EAA8B;AAC1CC,qBAAS,UADiC;AAE1CC,wBAAY;AAF8B,SAA9B,CAAhB;;AAKA,aAAKC,SAAL,GAAiB,IAAIC,IAAJ,EAAjB;;AAEAN,gBAAQO,EAAR,CAAW,KAAX,EAAkB,UAACC,KAAD,EAAQC,KAAR,EAAkB;;AAEhC,gBAAMC,eAAe,eAAKC,QAAL,CAAcZ,MAAMa,QAApB,EAA8BJ,KAA9B,CAArB;AACA,gBAAMK,cAAcL,MAAMM,OAAN,OAAkBf,MAAMgB,OAAxB,cAAwChB,MAAMiB,WAA9C,OAApB;AACA,gBAAMC,MAAM,IAAIX,IAAJ,EAAZ;;AAEA,gBAAIW,MAAM,MAAKZ,SAAX,GAAuB,GAA3B,EAAgC;AAC5B,gCAAMK,YAAN,EAAoB,KAApB;;AAEA,sBAAKQ,OAAL;AACA,sBAAKC,UAAL,CAAgB,KAAhB;AACH,aALD,MAKO;AACH,sBAAKd,SAAL,GAAiBY,GAAjB;AACH;AACJ,SAdD;;AAgBAjB,gBAAQO,EAAR,CAAW,QAAX,EAAqB,UAACC,KAAD,EAAQC,KAAR,EAAkB;;AAEnC,gBAAMC,eAAe,eAAKC,QAAL,CAAcZ,MAAMa,QAApB,EAA8BJ,KAA9B,CAArB;AACA,gBAAMK,cAAcL,MAAMM,OAAN,OAAkBf,MAAMgB,OAAxB,cAAwChB,MAAMiB,WAA9C,OAApB;;AAEA,4BAAMN,YAAN,EAAoB,QAApB;;AAEA,mCAAWG,WAAX;;AAEA,kBAAKK,OAAL;AACA,kBAAKC,UAAL,CAAgB,QAAhB,EAA0BN,WAA1B;AACH,SAXD;;AAaAb,gBAAQO,EAAR,CAAW,QAAX,EAAqB,UAACC,KAAD,EAAQC,KAAR,EAAkB;;AAEnC,gBAAMC,eAAe,eAAKC,QAAL,CAAcZ,MAAMa,QAApB,EAA8BJ,KAA9B,CAArB;AACA,gBAAMK,cAAcL,MAAMM,OAAN,OAAkBf,MAAMgB,OAAxB,cAAwChB,MAAMiB,WAA9C,OAApB;;AAEA,mCAAWH,WAAX;;AAEA,yBAAGO,MAAH,CAAUP,WAAV,EAAuB,YAAM;AACzB,gCAAMH,YAAN,EAAoB,QAApB;;AAEA,sBAAKQ,OAAL;AACA,sBAAKC,UAAL,CAAgB,QAAhB,EAA0BN,WAA1B;AACH,aALD;AAMH,SAbD;AAcH;;AAED;;;;;mCACWQ,I,EAAMC,I,EAAM;AACnB,gBAAIC,OAAOC,MAAP,CAAc,SAAd,CAAJ,EAA8B;AAC1B,qBAAK,IAAIC,EAAT,IAAe,kBAAQC,OAAvB,EAAgC;AAC5B,sCAAQA,OAAR,CAAgBD,EAAhB,EAAoBE,IAApB,CAAyB,EAACC,MAAM,MAAP,EAAeP,MAAMA,IAArB,EAA2BC,MAAMA,IAAjC,EAAzB;AACH;AACJ;AACJ;;AAED;;;;kCAmBU;;AAENO,uBAAW,YAAY;AACnB;AACH,aAFD,EAEG,GAFH;AAGH;;;kCAvBgBC,G,EAAK;AAClB,gBAAIA,IAAIT,IAAJ,IAAY,QAAhB,EAA0B;AACtB,uCAAWS,IAAIR,IAAf;AACH;;AAED,gBAAIQ,IAAIT,IAAJ,IAAY,KAAhB,EAAuB,CAEtB;;AAED,gBAAIS,IAAIT,IAAJ,IAAY,QAAhB,EAA0B;AACtB,uCAAWS,IAAIR,IAAf;AACH;;AAEDO,uBAAW,YAAY;AACnB;AACH,aAFD,EAEG,GAFH;AAGH","file":"watcher.class.js","sourcesContent":["import chokidar from \"chokidar\";\nimport path from \"path\";\nimport fs from \"fs\";\nimport cluster from \"cluster\";\nimport Koahub from \"./../\";\nimport {watch as debug} from \"./../util/log.util\";\nimport {cleanCache} from \"./../util/cache.util\";\n\nexport default class {\n\n    constructor(paths = {}) {\n\n        const watcher = chokidar.watch(paths.appPath, {\n            ignored: /[\\/\\\\]\\./,\n            persistent: true\n        });\n\n        this.startTime = new Date();\n\n        watcher.on('add', (_path, stats) => {\n\n            const relativePath = path.relative(paths.rootPath, _path);\n            const runtimePath = _path.replace(`/${paths.appName}/`, `/${paths.runtimeName}/`);\n            const now = new Date();\n\n            if (now - this.startTime > 600) {\n                debug(relativePath, 'add');\n\n                this.restart();\n                this.masterSend('add');\n            } else {\n                this.startTime = now;\n            }\n        });\n\n        watcher.on('change', (_path, stats) => {\n\n            const relativePath = path.relative(paths.rootPath, _path);\n            const runtimePath = _path.replace(`/${paths.appName}/`, `/${paths.runtimeName}/`);\n\n            debug(relativePath, 'change');\n\n            cleanCache(runtimePath);\n\n            this.restart();\n            this.masterSend('change', runtimePath);\n        });\n\n        watcher.on('unlink', (_path, stats) => {\n\n            const relativePath = path.relative(paths.rootPath, _path);\n            const runtimePath = _path.replace(`/${paths.appName}/`, `/${paths.runtimeName}/`);\n\n            cleanCache(runtimePath);\n\n            fs.unlink(runtimePath, () => {\n                debug(relativePath, 'unlink');\n\n                this.restart();\n                this.masterSend('unlink', runtimePath);\n            });\n        });\n    }\n\n    // master线程通知子线程\n    masterSend(type, file) {\n        if (koahub.config('cluster')) {\n            for (let id in cluster.workers) {\n                cluster.workers[id].send({name: 'file', type: type, file: file});\n            }\n        }\n    }\n\n    // worker线程收到消息通知\n    static workerGet(msg) {\n        if (msg.type == 'change') {\n            cleanCache(msg.file);\n        }\n\n        if (msg.type == 'add') {\n\n        }\n\n        if (msg.type == 'unlink') {\n            cleanCache(msg.file);\n        }\n\n        setTimeout(function () {\n            new Koahub();\n        }, 600);\n    }\n\n    restart() {\n\n        setTimeout(function () {\n            new Koahub();\n        }, 600);\n    }\n}"]}