{"version":3,"sources":["../../src/lib/watcher.class.js"],"names":["paths","watcherPaths","key","koahub","config","loader","isArray","_key","root","push","replace","runtimeName","appName","union","watcher","watch","ignored","persistent","on","_path","stats","runtimePath","undefined","restart","clear","unlink","file","isAbsolute","resolve","rootPath","TypeError","require","cache","parent","i","children","length","id","splice","setTimeout"],"mappings":"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","file":"watcher.class.js","sourcesContent":["import chokidar from \"chokidar\";\nimport lodash from \"lodash\";\nimport path from \"path\";\nimport fs from \"fs\";\nimport Koahub from \"./../\";\nimport {watch as debug} from \"./../util/log.util\";\n\nexport default class {\n\n    // 监控 loader自动加载的文件\n    constructor(paths) {\n\n        let watcherPaths = [];\n        for (let key in koahub.config('loader')) {\n            const loader = koahub.config('loader')[key];\n            if (lodash.isArray(loader)) {\n                for (let _key in loader) {\n                    const root = loader[_key].root;\n                    watcherPaths.push(root.replace(`${paths.runtimeName}/`, `${paths.appName}/`));\n                }\n            } else {\n                const root = loader.root;\n                watcherPaths.push(root.replace(`${paths.runtimeName}/`, `${paths.appName}/`));\n            }\n        }\n        watcherPaths = lodash.union(watcherPaths);\n\n        const watcher = chokidar.watch(watcherPaths, {\n            ignored: /[\\/\\\\]\\./,\n            persistent: true\n        });\n\n        watcher.on('add', (_path, stats) => {\n\n            const runtimePath = _path.replace(`${paths.appName}/`, `${paths.runtimeName}/`);\n\n            // 新增文件stats undefined\n            if (stats == undefined) {\n                debug(_path, 'add');\n                this.restart();\n            }\n        });\n\n        watcher.on('change', (_path, stats) => {\n\n            const runtimePath = _path.replace(`${paths.appName}/`, `${paths.runtimeName}/`);\n\n            debug(_path, 'change');\n            this.clear(runtimePath);\n        });\n\n        watcher.on('unlink', (_path, stats) => {\n\n            const runtimePath = _path.replace(`${paths.appName}/`, `${paths.runtimeName}/`);\n\n            fs.unlink(runtimePath, () => {\n                debug(_path, 'unlink');\n                this.clear(runtimePath);\n            });\n        });\n    }\n\n    clear(file) {\n\n        if (!path.isAbsolute(file)) {\n            file = path.resolve(koahub.paths.rootPath, file);\n        }\n\n        if (typeof file !== 'string') {\n            throw new TypeError('Expected a string');\n        }\n\n        // delete itself from module parent\n        if (require.cache[file] && require.cache[file].parent) {\n            var i = require.cache[file].parent.children.length;\n\n            while (i--) {\n                if (require.cache[file].parent.children[i].id === file) {\n                    require.cache[file].parent.children.splice(i, 1);\n                }\n            }\n        }\n\n        // delete module from cache\n        delete require.cache[file];\n\n        this.restart();\n    }\n\n    restart() {\n\n        // babel compile延时\n        setTimeout(function () {\n            new Koahub();\n        }, 200);\n    }\n}"]}