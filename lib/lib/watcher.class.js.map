{"version":3,"sources":["../../src/lib/watcher.class.js"],"names":["paths","watcher","watch","appPath","ignored","persistent","on","_path","stats","relativePath","relative","rootPath","runtimePath","replace","appName","runtimeName","undefined","restart","clear","unlink","file","TypeError","require","cache","parent","i","children","length","id","splice","setTimeout"],"mappings":";;;;;;;;;;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;AAII,sBAAwB;AAAA;;AAAA,YAAZA,KAAY,uEAAJ,EAAI;AAAA;;;AAEpB,YAAMC,UAAU,mBAASC,KAAT,CAAeF,MAAMG,OAArB,EAA8B;AAC1CC,qBAAS,UADiC;AAE1CC,wBAAY;AAF8B,SAA9B,CAAhB;;AAKAJ,gBAAQK,EAAR,CAAW,KAAX,EAAkB,UAACC,KAAD,EAAQC,KAAR,EAAkB;;AAEhC,gBAAMC,eAAe,eAAKC,QAAL,CAAcV,MAAMW,QAApB,EAA8BJ,KAA9B,CAArB;AACA,gBAAMK,cAAcL,MAAMM,OAAN,OAAkBb,MAAMc,OAAxB,cAAwCd,MAAMe,WAA9C,OAApB;;AAEA;AACA,gBAAIP,SAASQ,SAAb,EAAwB;AACpB,gCAAMP,YAAN,EAAoB,KAApB;AACA,sBAAKQ,OAAL;AACH;AACJ,SAVD;;AAYAhB,gBAAQK,EAAR,CAAW,QAAX,EAAqB,UAACC,KAAD,EAAQC,KAAR,EAAkB;;AAEnC,gBAAMC,eAAe,eAAKC,QAAL,CAAcV,MAAMW,QAApB,EAA8BJ,KAA9B,CAArB;AACA,gBAAMK,cAAcL,MAAMM,OAAN,OAAkBb,MAAMc,OAAxB,cAAwCd,MAAMe,WAA9C,OAApB;;AAEA,4BAAMN,YAAN,EAAoB,QAApB;AACA,kBAAKS,KAAL,CAAWN,WAAX;AACH,SAPD;;AASAX,gBAAQK,EAAR,CAAW,QAAX,EAAqB,UAACC,KAAD,EAAQC,KAAR,EAAkB;;AAEnC,gBAAMC,eAAe,eAAKC,QAAL,CAAcV,MAAMW,QAApB,EAA8BJ,KAA9B,CAArB;AACA,gBAAMK,cAAcL,MAAMM,OAAN,OAAkBb,MAAMc,OAAxB,cAAwCd,MAAMe,WAA9C,OAApB;;AAEA,yBAAGI,MAAH,CAAUP,WAAV,EAAuB,YAAM;AACzB,gCAAMH,YAAN,EAAoB,QAApB;AACA,sBAAKS,KAAL,CAAWN,WAAX;AACH,aAHD;AAIH,SATD;AAUH;;;;8BAEKQ,I,EAAM;;AAER,gBAAI,OAAOA,IAAP,KAAgB,QAApB,EAA8B;AAC1B,sBAAM,IAAIC,SAAJ,CAAc,mBAAd,CAAN;AACH;;AAED;AACA,gBAAIC,QAAQC,KAAR,CAAcH,IAAd,KAAuBE,QAAQC,KAAR,CAAcH,IAAd,EAAoBI,MAA/C,EAAuD;AACnD,oBAAIC,IAAIH,QAAQC,KAAR,CAAcH,IAAd,EAAoBI,MAApB,CAA2BE,QAA3B,CAAoCC,MAA5C;;AAEA,uBAAOF,GAAP,EAAY;AACR,wBAAIH,QAAQC,KAAR,CAAcH,IAAd,EAAoBI,MAApB,CAA2BE,QAA3B,CAAoCD,CAApC,EAAuCG,EAAvC,KAA8CR,IAAlD,EAAwD;AACpDE,gCAAQC,KAAR,CAAcH,IAAd,EAAoBI,MAApB,CAA2BE,QAA3B,CAAoCG,MAApC,CAA2CJ,CAA3C,EAA8C,CAA9C;AACH;AACJ;AACJ;;AAED;AACA,mBAAOH,QAAQC,KAAR,CAAcH,IAAd,CAAP;;AAEA,iBAAKH,OAAL;AACH;;;kCAES;;AAEN;AACAa,uBAAW,YAAY;AACnB;AACH,aAFD,EAEG,GAFH;AAGH","file":"watcher.class.js","sourcesContent":["import chokidar from \"chokidar\";\nimport path from \"path\";\nimport fs from \"fs\";\nimport Koahub from \"./../\";\nimport {watch as debug} from \"./../util/log.util\";\n\nexport default class {\n\n    constructor(paths = {}) {\n\n        const watcher = chokidar.watch(paths.appPath, {\n            ignored: /[\\/\\\\]\\./,\n            persistent: true\n        });\n\n        watcher.on('add', (_path, stats) => {\n\n            const relativePath = path.relative(paths.rootPath, _path);\n            const runtimePath = _path.replace(`/${paths.appName}/`, `/${paths.runtimeName}/`);\n\n            // 新增文件stats undefined\n            if (stats == undefined) {\n                debug(relativePath, 'add');\n                this.restart();\n            }\n        });\n\n        watcher.on('change', (_path, stats) => {\n\n            const relativePath = path.relative(paths.rootPath, _path);\n            const runtimePath = _path.replace(`/${paths.appName}/`, `/${paths.runtimeName}/`);\n\n            debug(relativePath, 'change');\n            this.clear(runtimePath);\n        });\n\n        watcher.on('unlink', (_path, stats) => {\n\n            const relativePath = path.relative(paths.rootPath, _path);\n            const runtimePath = _path.replace(`/${paths.appName}/`, `/${paths.runtimeName}/`);\n\n            fs.unlink(runtimePath, () => {\n                debug(relativePath, 'unlink');\n                this.clear(runtimePath);\n            });\n        });\n    }\n\n    clear(file) {\n\n        if (typeof file !== 'string') {\n            throw new TypeError('Expected a string');\n        }\n\n        // delete itself from module parent\n        if (require.cache[file] && require.cache[file].parent) {\n            var i = require.cache[file].parent.children.length;\n\n            while (i--) {\n                if (require.cache[file].parent.children[i].id === file) {\n                    require.cache[file].parent.children.splice(i, 1);\n                }\n            }\n        }\n\n        // delete module from cache\n        delete require.cache[file];\n\n        this.restart();\n    }\n\n    restart() {\n\n        // babel compile延时\n        setTimeout(function () {\n            new Koahub();\n        }, 200);\n    }\n}"]}