{"version":3,"sources":["../../src/lib/watcher.class.js"],"names":["paths","watcher","watch","runtimePath","ignored","persistent","unwatch","mainFile","startTime","Date","on","_path","stats","relativePath","relative","rootPath","replace","appName","runtimeName","now","restart","masterSend","unlink","type","file","koahub","config","id","workers","send","name","setTimeout","msg"],"mappings":";;;;;;;;;;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;AAII,sBAAwB;AAAA;;AAAA,YAAZA,KAAY,uEAAJ,EAAI;AAAA;;;AAEpB,YAAMC,UAAU,mBAASC,KAAT,CAAeF,MAAMG,WAArB,EAAkC;AAC9CC,qBAAS,UADqC;AAE9CC,wBAAY;AAFkC,SAAlC,EAGbC,OAHa,CAGLN,MAAMO,QAHD,CAAhB;;AAKA,aAAKC,SAAL,GAAiB,IAAIC,IAAJ,EAAjB;;AAEAR,gBAAQS,EAAR,CAAW,KAAX,EAAkB,UAACC,KAAD,EAAQC,KAAR,EAAkB;;AAEhC,gBAAMC,eAAe,eAAKC,QAAL,CAAcd,MAAMe,QAApB,EAA8BJ,KAA9B,CAArB;AACA,gBAAMR,cAAcQ,MAAMK,OAAN,OAAkBhB,MAAMiB,OAAxB,cAAwCjB,MAAMkB,WAA9C,OAApB;AACA,gBAAMC,MAAM,IAAIV,IAAJ,EAAZ;;AAEA,gBAAIU,MAAM,MAAKX,SAAX,GAAuB,GAA3B,EAAgC;AAC5B,gCAAMK,YAAN,EAAoB,KAApB;;AAEA,sBAAKO,OAAL;AACA,sBAAKC,UAAL,CAAgB,KAAhB;AACH,aALD,MAKO;AACH,sBAAKb,SAAL,GAAiBW,GAAjB;AACH;AACJ,SAdD;;AAgBAlB,gBAAQS,EAAR,CAAW,QAAX,EAAqB,UAACC,KAAD,EAAQC,KAAR,EAAkB;;AAEnC,gBAAMC,eAAe,eAAKC,QAAL,CAAcd,MAAMe,QAApB,EAA8BJ,KAA9B,CAArB;AACA,gBAAMR,cAAcQ,MAAMK,OAAN,OAAkBhB,MAAMiB,OAAxB,cAAwCjB,MAAMkB,WAA9C,OAApB;;AAEA,4BAAML,YAAN,EAAoB,QAApB;;AAEA,mCAAQV,WAAR;;AAEA,kBAAKiB,OAAL;AACA,kBAAKC,UAAL,CAAgB,QAAhB,EAA0BlB,WAA1B;AACH,SAXD;;AAaAF,gBAAQS,EAAR,CAAW,QAAX,EAAqB,UAACC,KAAD,EAAQC,KAAR,EAAkB;;AAEnC,gBAAMC,eAAe,eAAKC,QAAL,CAAcd,MAAMe,QAApB,EAA8BJ,KAA9B,CAArB;AACA,gBAAMR,cAAcQ,MAAMK,OAAN,OAAkBhB,MAAMiB,OAAxB,cAAwCjB,MAAMkB,WAA9C,OAApB;;AAEA,mCAAQf,WAAR;;AAEA,yBAAGmB,MAAH,CAAUnB,WAAV,EAAuB,YAAM;AACzB,gCAAMU,YAAN,EAAoB,QAApB;;AAEA,sBAAKO,OAAL;AACA,sBAAKC,UAAL,CAAgB,QAAhB,EAA0BlB,WAA1B;AACH,aALD;AAMH,SAbD;AAcH;;AAED;;;;;mCACWoB,I,EAAMC,I,EAAM;AACnB,gBAAIC,OAAOC,MAAP,CAAc,SAAd,CAAJ,EAA8B;AAC1B,qBAAK,IAAIC,EAAT,IAAe,kBAAQC,OAAvB,EAAgC;AAC5B,sCAAQA,OAAR,CAAgBD,EAAhB,EAAoBE,IAApB,CAAyB,EAACC,MAAM,MAAP,EAAeP,MAAMA,IAArB,EAA2BC,MAAMA,IAAjC,EAAzB;AACH;AACJ;AACJ;;AAED;;;;kCAmBU;;AAENO,uBAAW,YAAY;AACnB;AACH,aAFD,EAEG,GAFH;AAGH;;;kCAvBgBC,G,EAAK;AAClB,gBAAIA,IAAIT,IAAJ,IAAY,QAAhB,EAA0B;AACtB,uCAAQS,IAAIR,IAAZ;AACH;;AAED,gBAAIQ,IAAIT,IAAJ,IAAY,KAAhB,EAAuB,CAEtB;;AAED,gBAAIS,IAAIT,IAAJ,IAAY,QAAhB,EAA0B;AACtB,uCAAQS,IAAIR,IAAZ;AACH;;AAEDO,uBAAW,YAAY;AACnB;AACH,aAFD,EAEG,GAFH;AAGH","file":"watcher.class.js","sourcesContent":["import chokidar from \"chokidar\";\nimport decache from \"decache\";\nimport path from \"path\";\nimport fs from \"fs\";\nimport cluster from \"cluster\";\nimport Koahub from \"./../\";\nimport {watch as debug} from \"./../util/log.util\";\n\nexport default class {\n\n    constructor(paths = {}) {\n\n        const watcher = chokidar.watch(paths.runtimePath, {\n            ignored: /[\\/\\\\]\\./,\n            persistent: true\n        }).unwatch(paths.mainFile);\n\n        this.startTime = new Date();\n\n        watcher.on('add', (_path, stats) => {\n\n            const relativePath = path.relative(paths.rootPath, _path);\n            const runtimePath = _path.replace(`/${paths.appName}/`, `/${paths.runtimeName}/`);\n            const now = new Date();\n\n            if (now - this.startTime > 600) {\n                debug(relativePath, 'add');\n\n                this.restart();\n                this.masterSend('add');\n            } else {\n                this.startTime = now;\n            }\n        });\n\n        watcher.on('change', (_path, stats) => {\n\n            const relativePath = path.relative(paths.rootPath, _path);\n            const runtimePath = _path.replace(`/${paths.appName}/`, `/${paths.runtimeName}/`);\n\n            debug(relativePath, 'change');\n\n            decache(runtimePath);\n\n            this.restart();\n            this.masterSend('change', runtimePath);\n        });\n\n        watcher.on('unlink', (_path, stats) => {\n\n            const relativePath = path.relative(paths.rootPath, _path);\n            const runtimePath = _path.replace(`/${paths.appName}/`, `/${paths.runtimeName}/`);\n\n            decache(runtimePath);\n\n            fs.unlink(runtimePath, () => {\n                debug(relativePath, 'unlink');\n\n                this.restart();\n                this.masterSend('unlink', runtimePath);\n            });\n        });\n    }\n\n    // master线程通知子线程\n    masterSend(type, file) {\n        if (koahub.config('cluster')) {\n            for (let id in cluster.workers) {\n                cluster.workers[id].send({name: 'file', type: type, file: file});\n            }\n        }\n    }\n\n    // worker线程收到消息通知\n    static workerGet(msg) {\n        if (msg.type == 'change') {\n            decache(msg.file);\n        }\n\n        if (msg.type == 'add') {\n\n        }\n\n        if (msg.type == 'unlink') {\n            decache(msg.file);\n        }\n\n        setTimeout(function () {\n            new Koahub();\n        }, 600);\n    }\n\n    restart() {\n\n        setTimeout(function () {\n            new Koahub();\n        }, 600);\n    }\n}"]}